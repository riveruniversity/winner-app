<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>River Winner</title>
  <!-- Meta Tags -->
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="Professional random winner selection application">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Bootstrap CSS for modern styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Toastify for notifications -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/src/css/styles.css">
</head>
<body data-theme="light" x-data>
  <!-- Main Public Selection Interface -->
  <div class="public-selection-interface" id="publicInterface" x-show="$store.ui.view === 'public'" x-cloak>
    <!-- Header -->
    <div class="selection-header">
      <div class="d-flex align-items-center">
        <img src="/favicon.png" width="40" class="me-2">
        <h4 class="mb-0"></h4>
      </div>
      <!-- Prize Display in Header (Hidden initially) -->
      <div class="prize-display-header d-none" id="prizeDisplay">
        <div class="prize-name-header" id="displayPrizeName"></div>
        <div class="prize-subtitle-header" id="displayPrizeSubtitle"></div>
      </div>
      <div class="d-flex gap-2">
        <!-- Winner Action Buttons (Hidden initially) -->
        <button class="btn btn-outline-light d-none" id="newSelectionBtn" title="Start new selection">
          <i class="bi bi-arrow-repeat"></i>
        </button>
        <button class="btn btn-outline-warning d-none" id="undoSelectionBtn" title="Undo last selection">
          <i class="bi bi-arrow-counterclockwise"></i>
        </button>
        <!-- SMS Button (Hidden initially) -->
        <button class="btn btn-outline-success d-none" id="sendSMSBtn" title="Send SMS to current winners">
          <i class="bi bi-envelope-fill"></i></button>
        <button class="btn btn-outline-light" id="fullscreenToggle" title="Toggle fullscreen">
          <i class="bi bi-fullscreen"></i>
        </button>
        <button class="btn btn-outline-light" id="managementToggle" x-on:click="$store.ui.showManagement()">
          <i class="bi bi-list-ul"></i> Manage
        </button>
      </div>
    </div>
    <!-- Main Selection Area -->
    <div class="selection-main">
      <!-- Selection Controls -->
      <div class="selection-controls" id="selectionControls">
        <h1 class="selection-title">Winner Selection</h1>
        <p class="selection-subtitle">Get ready for the big moment!</p>
        <!-- Selection Info -->
        <div class="selection-info">
          <div class="info-card">
            <div class="info-label">Current List</div>
            <div class="info-value" id="currentListDisplay" x-text="$store.setup.listDisplayText">Not Selected</div>
          </div>
          <div class="info-card" id="totalEntriesCard" x-show="!$store.settings.hideEntryCounts">
            <div class="info-label">Eligible Entries</div>
            <div class="info-value" id="totalEntriesDisplay" x-text="$store.setup.eligibleEntries.toLocaleString() + ($store.setup.excludedCount > 0 ? ' (' + $store.setup.excludedCount + ' excluded)' : '')">0</div>
          </div>
          <div class="info-card">
            <div class="info-label">Winners to Select</div>
            <div class="info-value" id="winnersCountDisplay"
                 :class="{ 'text-danger': $store.setup.hasValidationWarning }"
                 x-text="$store.setup.winnersCount">1</div>
          </div>
          <div class="info-card">
            <div class="info-label">Prize</div>
            <div class="info-value" id="currentPrizeDisplay" x-text="$store.setup.prizeDisplayText">Not Selected</div>
          </div>
        </div>
        <!-- Big Play Button -->
        <button class="big-play-button" id="bigPlayButton" :disabled="!$store.setup.canStart">
          <i class="bi bi-play-fill"></i>
        </button>
      </div>
      <!-- Winners Grid Display -->
      <div class="winners-grid d-none" id="winnersGrid">
        <!-- Winner cards will be inserted here dynamically -->
      </div>
    </div>
  </div>
  <!-- Management (Hidden by default) -->
  <div class="container-fluid management-tabs" id="managementInterface" :class="{ 'active': $store.ui.view === 'management' }" x-cloak>
    <div class="row">
      <div class="col-12">
        <!-- Header for management -->
        <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
          <h3><i class="bi bi-gear me-2"></i>Management</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-light" id="themeToggle" title="Toggle theme">
              <i class="bi bi-moon-fill"></i>
            </button>
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="./scan.html" target="_blank"><i class="bi bi-qr-code-scan me-2"></i>Prize Pickup Scanner</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="undoLastSelection"><i class="bi bi-arrow-counterclockwise me-2"></i>Undo Last Selection</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="backupData"><i class="bi bi-download me-2"></i>Backup Local</a></li>
                <li><a class="dropdown-item" href="#" id="restoreData"><i class="bi bi-upload me-2"></i>Restore Local</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="backupOnline"><i class="bi bi-cloud-upload me-2"></i>Backup Online</a></li>
                <li><a class="dropdown-item" href="#" id="restoreOnline"><i class="bi bi-cloud-download me-2"></i>Restore Online</a></li>
              </ul>
            </div>
            <button class="btn btn-primary" id="backToPublicBtn" x-on:click="$store.ui.showPublic()">
              <i class="bi bi-eye me-2"></i>Public View
            </button>
          </div>
        </div>
        <!-- Management Tabs -->
        <ul class="nav nav-tabs mt-3" id="managementTabs" role="tablist"
            x-init="$el.addEventListener('shown.bs.tab', (e) => $store.ui.setTab(e.target.getAttribute('data-bs-target').replace('#', '')))">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="quicksetup-tab" data-bs-toggle="tab" data-bs-target="#quicksetup" type="button" role="tab">
              <i class="bi bi-play-circle me-2"></i>Setup
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="lists-tab" data-bs-toggle="tab" data-bs-target="#lists" type="button" role="tab">
              <i class="bi bi-list-ul me-2"></i>Lists
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="prizes-tab" data-bs-toggle="tab" data-bs-target="#prizes" type="button" role="tab">
              <i class="bi bi-gift me-2"></i>Prizes
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
              <i class="bi bi-chat-text me-2"></i>Templates
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="winners-tab" data-bs-toggle="tab" data-bs-target="#winners" type="button" role="tab">
              <i class="bi bi-trophy me-2"></i>Winners
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
              <i class="bi bi-clock-history me-2"></i>History
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="queries-tab" data-bs-toggle="tab" data-bs-target="#queries" type="button" role="tab">
              <i class="bi bi-database me-2"></i>Queries
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
              <i class="bi bi-sliders me-2"></i>Settings
            </button>
          </li>
        </ul>
        <!-- Tab Content -->
        <div class="tab-content mt-3" id="managementTabContent">
          <!-- Setup Tab -->
          <div class="tab-pane fade show active" id="quicksetup" role="tabpanel" x-data>
            <!-- Row 1: Full Width Quick Selection Setup -->
            <div class="card">
              <div class="card-header">
                <h5 class="card-title"><i class="bi bi-gear-fill me-2"></i>Quick Selection Setup</h5>
              </div>
              <div class="card-body">
                <p class="card-text text-muted mb-4">Configure the next public winner selection from here.</p>
                <!-- Main Selection Controls in a Row -->
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label fw-semibold">Select Lists</label>
                    <div class="list-selection-container">
                      <div class="list-checkboxes border rounded p-2" id="quickListSelect" style="max-height: 200px; overflow-y: auto;">
                        <template x-for="list in $store.data.lists" :key="list.listId">
                          <div class="form-check">
                            <input class="form-check-input list-checkbox" type="checkbox"
                                   :id="'list-' + list.listId"
                                   :value="list.listId"
                                   :data-entry-count="list.entries.length"
                                   :checked="$store.setup.selectedListIds.includes(list.listId)"
                                   @change="$store.setup.toggleList(list.listId)">
                            <label class="form-check-label" :for="'list-' + list.listId">
                              <span x-text="list.metadata.name"></span>
                              <span class="text-muted" x-text="'(' + list.entries.length + ')'"></span>
                            </label>
                          </div>
                        </template>
                        <p x-show="$store.data.lists.length === 0" class="text-muted mb-0">No lists uploaded yet</p>
                      </div>
                      <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="list-selection-controls">
                          <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllLists">Select All</button>
                          <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllLists">Clear All</button>
                          <span class="ms-2 text-muted" x-text="$store.setup.validSelectedCount + ' selected'"></span>
                        </div>
                        <small class="text-muted">Eligible: <span x-text="$store.setup.eligibleEntries.toLocaleString() + ($store.setup.excludedCount > 0 ? ' (' + $store.setup.excludedCount + ' excluded)' : '')">0</span></small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <label class="form-label fw-semibold">Select Prize</label>
                    <select class="form-select form-select-lg" id="quickPrizeSelect"
                            x-model="$store.setup.selectedPrizeId"
                            @change="$store.setup.onPrizeChange()">
                      <option value="">Select Prize...</option>
                      <template x-for="prize in $store.data.prizes" :key="prize.prizeId">
                        <option :value="prize.prizeId" x-text="prize.name + ' (' + prize.quantity + ' available)'" :selected="prize.prizeId === $store.setup.selectedPrizeId"></option>
                      </template>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold">Number of Winners</label>
                    <input type="number" class="form-control form-control-lg" id="quickWinnersCount" min="1" max="9999" placeholder="Count"
                           x-model.number="$store.setup.winnersCount"
                           :class="{ 'border-danger text-danger': $store.setup.hasValidationWarning }">
                    <template x-if="$store.setup.entriesExceeded">
                      <small class="text-danger d-block mt-1"
                             x-text="$store.setup.eligibleEntries === 0 ? 'No entries available' : 'Only ' + $store.setup.eligibleEntries + ' entries available' + ($store.setup.excludedCount > 0 ? ' (' + $store.setup.excludedCount + ' excluded)' : '')"></small>
                    </template>
                    <template x-if="$store.setup.prizeQuantityExceeded && !$store.setup.entriesExceeded">
                      <small class="text-danger d-block mt-1"
                             x-text="'Only ' + $store.setup.selectedPrizeQuantity + ' prizes available'"></small>
                    </template>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Row 2: Reveal Settings | Delay Settings -->
            <div class="row g-4 mt-3">
              <!-- Reveal Settings Card (Left Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-eye-fill me-2"></i>Reveal Settings
                      <i class="bi bi-info-circle text-muted ms-1" title="Configure how winners are revealed"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Selection Mode
                        <i class="bi bi-info-circle text-muted ms-1" title="How winners are selected and revealed"></i>
                      </label>
                      <select class="form-select form-select-lg" id="selectionMode"
                              x-model="$store.settings.selectionMode"
                              @change="$store.settings.save('selectionMode')">
                        <option value="all-at-once">All at Once</option>
                        <option value="sequential">Sequential Reveal</option>
                        <option value="individual">Individual Selection</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Display Effect
                        <i class="bi bi-info-circle text-muted ms-1" title="How winners appear on screen"></i>
                      </label>
                      <select class="form-select form-select-lg" id="displayEffect"
                              x-model="$store.settings.displayEffect"
                              @change="$store.settings.save('displayEffect')">
                        <option value="fade-in">Fade In</option>
                        <option value="fly-in">Fly In</option>
                        <option value="zoom-in">Zoom In</option>
                        <option value="slide-in">Slide In</option>
                        <option value="bounce-in">Bounce In</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Time Between Winners (seconds)
                        <i class="bi bi-info-circle text-muted ms-1" title="Delay between each winner being revealed (sequential mode only)"></i>
                      </label>
                      <input type="number" class="form-control form-control-lg" id="displayDuration" value="0.5" min="0.1" max="5" step="0.1"
                             x-model.number="$store.settings.displayDuration"
                             @change="$store.settings.save('displayDuration')">
                    </div>
                    <div class="mb-3" x-show="$store.settings.selectionMode === 'sequential' || $store.settings.selectionMode === 'individual'">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="stableGrid"
                               x-model="$store.settings.stableGrid"
                               @change="$store.settings.save('stableGrid')">
                        <label class="form-check-label fw-semibold" for="stableGrid">
                          Stable Grid
                          <i class="bi bi-info-circle text-muted ms-1" title="Pre-position all cards to prevent grid shifting during reveal"></i>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Delay Settings Card (Right Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-clock-fill me-2"></i>Delay Settings
                      <i class="bi bi-info-circle text-muted ms-1" title="Configure pre-selection delay options"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Delay Duration (seconds)
                        <i class="bi bi-info-circle text-muted ms-1" title="Delay before selection begins"></i>
                      </label>
                      <input type="number" class="form-control form-control-lg" id="preSelectionDelay" value="0" min="0" max="30" step="0.5"
                             x-model.number="$store.settings.preSelectionDelay"
                             @change="$store.settings.save('preSelectionDelay')">
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Delay Visual
                        <i class="bi bi-info-circle text-muted ms-1" title="What to show during the delay"></i>
                      </label>
                      <select class="form-select form-select-lg" id="delayVisualType"
                              x-model="$store.settings.delayVisualType"
                              @change="$store.settings.save('delayVisualType')">
                        <option value="none">No Visual (Silent)</option>
                        <option value="countdown">Countdown Timer</option>
                        <option value="animation">Particle Animation</option>
                        <option value="swirl-animation">Swirl Animation</option>
                        <option value="christmas-snow">Christmas Snow</option>
                        <option value="time-machine">Time Machine</option>
                      </select>
                    </div>
                    <div>
                      <button type="button" class="btn btn-outline-info" id="previewDelayBtn">
                        <i class="bi bi-eye me-1"></i>Preview Delay
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Row 3: Celebration Effects | Sound Settings -->
            <div class="row g-4 mt-3">
              <!-- Celebration Effects Card (Left Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-star-fill me-2"></i>Celebration Effects
                      <i class="bi bi-info-circle text-muted ms-1" title="Visual effects when winners are revealed"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="celebrationEffect" class="form-label fw-semibold">Celebration Animation</label>
                      <select class="form-select form-select-lg" id="celebrationEffect"
                              x-model="$store.settings.celebrationEffect"
                              @change="$store.settings.save('celebrationEffect')">
                        <option value="none">No Animation</option>
                        <option value="confetti">Confetti</option>
                        <option value="coins">Gold Coins</option>
                        <option value="both">Both Confetti & Coins</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="celebrationDuration" class="form-label fw-semibold">Animation Duration (seconds)</label>
                      <input type="number" class="form-control form-control-lg" id="celebrationDuration" min="1" max="10" step="0.5" value="4"
                             x-model.number="$store.settings.celebrationDuration"
                             @change="$store.settings.save('celebrationDuration')">
                    </div>
                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="celebrationAutoTrigger"
                               x-model="$store.settings.celebrationAutoTrigger"
                               @change="$store.settings.save('celebrationAutoTrigger')">
                        <label class="form-check-label" for="celebrationAutoTrigger">
                          Auto-trigger celebration when winners are revealed
                        </label>
                      </div>
                    </div>
                    <div>
                      <button type="button" class="btn btn-sm btn-outline-secondary" id="testCelebrationEffect">
                        <i class="bi bi-play-fill me-1"></i>Test Celebration
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Sound Settings Card (Right Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-volume-up-fill me-2"></i>Sound Settings
                      <i class="bi bi-info-circle text-muted ms-1" title="Configure sound effects for the selection process"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Sound During Delay
                        <i class="bi bi-info-circle text-muted ms-1" title="Sound effect played during pre-selection delay"></i>
                      </label>
                      <div class="input-group">
                        <select class="form-select form-select-lg" id="soundDuringDelay"
                                x-model="$store.settings.soundDuringDelay"
                                @change="$store.settings.save('soundDuringDelay')">
                          <option value="none">No Sound</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="testSoundDuringDelay">
                          <i class="bi bi-play-fill"></i> Test
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Sound at End of Delay
                        <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Sound effect when delay completes"></i>
                      </label>
                      <div class="input-group">
                        <select class="form-select form-select-lg" id="soundEndOfDelay"
                                x-model="$store.settings.soundEndOfDelay"
                                @change="$store.settings.save('soundEndOfDelay')">
                          <option value="none">No Sound</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="testSoundEndOfDelay">
                          <i class="bi bi-play-fill"></i> Test
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Sound During Reveal
                        <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Sound effect when winners are revealed"></i>
                      </label>
                      <div class="input-group">
                        <select class="form-select form-select-lg" id="soundDuringReveal"
                                x-model="$store.settings.soundDuringReveal"
                                @change="$store.settings.save('soundDuringReveal')">
                          <option value="none">No Sound</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="testSoundDuringReveal">
                          <i class="bi bi-play-fill"></i> Test
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Lists Tab -->
      <div class="tab-pane fade" id="lists" role="tabpanel" x-data>
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title mb-0">List Management</h5>
              <!-- Sort Controls -->
              <div class="btn-group btn-group-sm" role="group" x-show="$store.data.lists.length > 0">
                <button type="button" class="btn"
                        :class="$store.lists.sortField === 'name' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="$store.lists.sortField = 'name'; $store.lists.sortDir = $store.lists.sortDir === 'asc' ? 'desc' : 'asc'">
                  Name <i class="bi" :class="$store.lists.sortField === 'name' ? ($store.lists.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : ''"></i>
                </button>
                <button type="button" class="btn"
                        :class="$store.lists.sortField === 'entries' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="$store.lists.sortField = 'entries'; $store.lists.sortDir = $store.lists.sortDir === 'asc' ? 'desc' : 'asc'">
                  Entries <i class="bi" :class="$store.lists.sortField === 'entries' ? ($store.lists.sortDir === 'asc' ? 'bi-sort-numeric-down' : 'bi-sort-numeric-up') : ''"></i>
                </button>
                <button type="button" class="btn"
                        :class="$store.lists.sortField === 'date' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="$store.lists.sortField = 'date'; $store.lists.sortDir = $store.lists.sortDir === 'asc' ? 'desc' : 'asc'">
                  Date <i class="bi" :class="$store.lists.sortField === 'date' ? ($store.lists.sortDir === 'asc' ? 'bi-sort-down' : 'bi-sort-up') : ''"></i>
                </button>
              </div>
              <div class="d-flex align-items-center gap-2">
                <div class="btn-group btn-group-sm" x-show="$store.data.lists.length > 0">
                  <button type="button" class="btn btn-outline-secondary" id="selectAllListsTab">
                    <i class="bi bi-check-square me-1"></i>Select All
                  </button>
                  <button type="button" class="btn btn-outline-secondary" id="clearAllListsTab">
                    <i class="bi bi-square me-1"></i>Clear All
                  </button>
                </div>
                <div class="dropdown">
                  <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-plus-circle me-2"></i>Add
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <a class="dropdown-item" href="#" id="uploadListModalBtn">
                        <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV File
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" id="addFromReportBtn">
                        <i class="bi bi-ticket-perforated me-2"></i>Pretix Report
                      </a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="#" id="addFromMPBtn">
                        <i class="bi bi-database me-2"></i>Ministry Platform
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Lists Grid -->
            <div class="row g-4 mt-2" id="listsGrid">
              <template x-for="list in $store.lists.sorted" :key="list.listId">
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 list-card-selectable"
                       :class="{ 'border-selected': $store.setup.selectedListIds.includes(list.listId) }">
                    <div class="card-header">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-truncate" x-text="list.metadata.name" style="max-width: 200px;"></h6>
                        <div>
                          <!-- Sync badge for MP-imported lists -->
                          <span class="badge bg-info me-1" x-show="list.metadata.mpSource" title="Syncable from Ministry Platform">
                            <i class="bi bi-cloud-arrow-down"></i>
                          </span>
                          <span class="badge badge-selection me-1" x-show="$store.setup.selectedListIds.includes(list.listId)">
                            <i class="bi bi-check-circle-fill"></i>
                          </span>
                          <span class="badge bg-secondary" x-text="list.entries.length"></span>
                        </div>
                      </div>
                    </div>
                    <div class="card-body d-flex flex-column">
                      <p class="card-text text-muted small mb-2">
                        Uploaded <span x-text="new Date(list.metadata.timestamp).toLocaleDateString()"></span>
                        <!-- Last sync time for MP lists -->
                        <span x-show="list.metadata.lastSyncAt" class="d-block">
                          <i class="bi bi-arrow-repeat"></i> Synced <span x-text="new Date(list.metadata.lastSyncAt).toLocaleDateString()"></span>
                        </span>
                      </p>
                      <div class="mt-auto pt-2" x-data="{ drawerOpen: false }">
                        <div class="d-flex justify-content-between align-items-center">
                          <button class="btn btn-sm"
                                  :class="$store.setup.selectedListIds.includes(list.listId) ? 'btn-selection' : 'btn-outline-selection'"
                                  @click.stop="$store.setup.toggleList(list.listId)">
                            <i :class="$store.setup.selectedListIds.includes(list.listId) ? 'bi bi-check-circle-fill' : 'bi bi-check-circle'"></i>
                            <span x-text="$store.setup.selectedListIds.includes(list.listId) ? 'Selected' : 'Select'"></span>
                          </button>
                          <div class="list-card-actions">
                            <!-- Drawer with extra action buttons (shown when open) -->
                            <div class="list-card-drawer" :class="{ 'open': drawerOpen }">
                              <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" @click.stop="Lists.editListConfig(list.listId)" title="Edit list settings">
                                  <i class="bi bi-gear"></i>
                                </button>
                                <button class="btn btn-outline-secondary" @click.stop="Lists.archiveListConfirm(list.listId)" title="Archive list">
                                  <i class="bi bi-archive"></i>
                                </button>
                                <button class="btn btn-outline-danger" @click.stop="Lists.deleteListConfirm(list.listId)" title="Delete list">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </div>
                            </div>
                            <!-- Main button group: toggle | sync | view -->
                            <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-secondary list-card-toggle"
                                      :class="{ 'radius-right': drawerOpen }"
                                      @click.stop="drawerOpen = !drawerOpen"
                                      :title="drawerOpen ? 'Hide actions' : 'More actions'">
                                <i class="bi" :class="drawerOpen ? 'bi-chevron-right' : 'bi-chevron-left'"></i>
                              </button>
                              <!-- Sync button (only for MP-imported lists, hidden when drawer open) -->
                              <button class="btn btn-outline-info list-card-sync"
                                      :class="{ 'hidden': drawerOpen }"
                                      x-show="list.metadata.mpSource"
                                      @click.stop="Lists.syncList(list.listId)"
                                      title="Sync from Ministry Platform">
                                <i class="bi bi-arrow-repeat"></i>
                              </button>
                              <!-- View button (hidden when drawer is open) -->
                              <button class="btn btn-outline-primary list-card-view"
                                      :class="{ 'hidden': drawerOpen }"
                                      @click.stop="Lists.viewList(list.listId)"
                                      title="View entries">
                                <i class="bi bi-eye"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <!-- Empty state -->
            <div id="noListsMessage" class="text-center py-5" x-show="$store.data.lists.length === 0">
              <i class="bi bi-file-earmark-spreadsheet display-1 text-muted"></i>
              <p class="text-muted mt-3">No lists uploaded yet</p>
            </div>
            <!-- Hidden input for CSV upload -->
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
          </div>
        </div>
        <!-- Configuration Card - Full Width -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card" id="nameConfigCard" style="display: none;">
              <div class="card-body">
                <div class="mb-3">
                  <label for="listName" class="form-label">List Name (Optional)</label>
                  <input type="text" class="form-control" id="listName" placeholder="Enter custom list name or leave empty to use filename">
                  <div class="form-text">If left empty, the CSV filename will be used as the list name.</div>
                </div>
                <!-- Import Configuration Wizard -->
                <hr>
                <div class="import-wizard" x-data="{ step: 1, totalSteps: 5, removeWinners: window.settings?.preventDuplicates ?? true }" id="importWizard">
                  <!-- Progress Indicator -->
                  <div class="wizard-progress mb-4">
                    <div class="d-flex justify-content-between align-items-center position-relative">
                      <!-- Progress Line Background -->
                      <div class="wizard-progress-line"></div>
                      <!-- Progress Line Active -->
                      <div class="wizard-progress-line-active" :style="'width: ' + ((step - 1) / (totalSteps - 1) * 100) + '%'"></div>

                      <!-- Step 1 -->
                      <div class="wizard-step" :class="{ 'active': step >= 1, 'current': step === 1 }" @click="step = 1">
                        <div class="wizard-step-circle">
                          <span x-show="step <= 1">1</span>
                          <i class="bi bi-check" x-show="step > 1"></i>
                        </div>
                        <div class="wizard-step-label">Record ID</div>
                      </div>

                      <!-- Step 2 -->
                      <div class="wizard-step" :class="{ 'active': step >= 2, 'current': step === 2 }" @click="step = 2">
                        <div class="wizard-step-circle">
                          <span x-show="step <= 2">2</span>
                          <i class="bi bi-check" x-show="step > 2"></i>
                        </div>
                        <div class="wizard-step-label">Import Options</div>
                      </div>

                      <!-- Step 3 -->
                      <div class="wizard-step" :class="{ 'active': step >= 3, 'current': step === 3 }" @click="step = 3">
                        <div class="wizard-step-circle">
                          <span x-show="step <= 3">3</span>
                          <i class="bi bi-check" x-show="step > 3"></i>
                        </div>
                        <div class="wizard-step-label">Winner Behavior</div>
                      </div>

                      <!-- Step 4 -->
                      <div class="wizard-step" :class="{ 'active': step >= 4, 'current': step === 4 }" @click="step = 4">
                        <div class="wizard-step-circle">
                          <span x-show="step <= 4">4</span>
                          <i class="bi bi-check" x-show="step > 4"></i>
                        </div>
                        <div class="wizard-step-label">Display Name</div>
                      </div>

                      <!-- Step 5 -->
                      <div class="wizard-step" :class="{ 'active': step >= 5, 'current': step === 5 }" @click="step = 5">
                        <div class="wizard-step-circle">5</div>
                        <div class="wizard-step-label">Card Display</div>
                      </div>
                    </div>
                  </div>

                  <!-- Step Content -->
                  <div class="wizard-content">
                    <!-- Step 1: Record ID Configuration -->
                    <div class="wizard-pane" x-show="step === 1" x-transition:enter="fade-in">
                      <h5 class="mb-3"><i class="bi bi-key me-2 text-primary"></i>Record ID Configuration</h5>
                      <p class="text-muted mb-4">Configure how each record is uniquely identified.</p>

                      <div class="mb-3">
                        <label class="form-label">Record ID Source</label>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="idSource" id="autoGenerateId" value="auto">
                          <label class="form-check-label" for="autoGenerateId">
                            Auto-generate unique IDs
                          </label>
                          <div class="form-text">System will create unique identifiers automatically.</div>
                        </div>
                        <div class="form-check mt-2">
                          <input class="form-check-input" type="radio" name="idSource" id="useColumnId" value="column" checked>
                          <label class="form-check-label" for="useColumnId">
                            Use column as record ID
                          </label>
                          <div class="form-text">Use an existing column (e.g., employee ID, email) as the unique identifier.</div>
                        </div>
                      </div>
                      <div class="mb-0" id="columnIdSection" style="display: none;">
                        <label for="idColumnSelect" class="form-label">Select ID Column</label>
                        <select class="form-select" id="idColumnSelect">
                          <option value="">Select a column...</option>
                        </select>
                        <div class="form-text">Selected column values must be unique for each record.</div>
                      </div>
                    </div>

                    <!-- Step 2: Import Options -->
                    <div class="wizard-pane" x-show="step === 2" x-transition:enter="fade-in">
                      <h5 class="mb-3"><i class="bi bi-filter me-2 text-primary"></i>Import Options</h5>
                      <p class="text-muted mb-4">Configure how records should be processed during import.</p>

                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="skipExistingWinners">
                        <label class="form-check-label" for="skipExistingWinners">
                          Skip records that are already in the winner list
                        </label>
                        <div class="form-text">Records are matched by their unique ID. Records with the same name but different IDs will still be uploaded.</div>
                      </div>
                    </div>

                    <!-- Step 3: Winner Behavior -->
                    <div class="wizard-pane" x-show="step === 3" x-transition:enter="fade-in" id="listSettingsSection">
                      <h5 class="mb-3"><i class="bi bi-trophy me-2 text-primary"></i>Winner Behavior</h5>
                      <p class="text-muted mb-4">Configure how winners are handled after selection.</p>

                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="listRemoveWinnersFromList"
                               x-model="removeWinners">
                        <label class="form-check-label" for="listRemoveWinnersFromList">
                          Remove winners from source list
                        </label>
                        <div class="form-text">When enabled, winners are removed from this list so they cannot win again.</div>
                      </div>

                      <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="listPreventWinningSamePrize"
                               :checked="!removeWinners" :disabled="!removeWinners">
                        <label class="form-check-label" for="listPreventWinningSamePrize">
                          Prevent winning same prize twice
                        </label>
                        <div class="form-text">Prevents the same person from winning the same prize type twice.</div>
                      </div>

                      <div class="alert alert-warning py-2" x-show="!removeWinners" x-transition>
                        <small><i class="bi bi-exclamation-triangle me-1"></i>Winners will remain in list but cannot win the same prize twice.</small>
                      </div>
                    </div>

                    <!-- Step 4: Display Name Configuration -->
                    <div class="wizard-pane" x-show="step === 4" x-transition:enter="fade-in">
                      <h5 class="mb-3"><i class="bi bi-person-badge me-2 text-primary"></i>Display Name</h5>
                      <p class="text-muted mb-4">Configure how names are displayed in lists. Click fields below to build your template.</p>

                      <div class="row">
                        <div class="col-lg-6">
                          <div class="mb-3">
                            <label for="nameTemplate" class="form-label">Name Template</label>
                            <input type="text" class="form-control" id="nameTemplate" placeholder="{LastName}, {FirstName}">
                          </div>
                        </div>
                        <div class="col-lg-6">
                          <div class="mb-3">
                            <label class="form-label">Preview</label>
                            <div class="p-2 bg-light border rounded" id="namePreview" style="min-height: 38px;"></div>
                          </div>
                        </div>
                      </div>
                      <div class="mb-0">
                        <label class="form-label">Available Fields</label>
                        <div id="availableFields" class="d-flex flex-wrap gap-2"></div>
                      </div>
                    </div>

                    <!-- Step 5: Winner Card Display Configuration -->
                    <div class="wizard-pane" x-show="step === 5" x-transition:enter="fade-in">
                      <h5 class="mb-3"><i class="bi bi-card-heading me-2 text-primary"></i>Winner Card Display</h5>
                      <p class="text-muted mb-4">Configure what information appears on winner cards during selection.</p>

                      <div class="row">
                        <div class="col-lg-4">
                          <div class="mb-3">
                            <label for="info1Template" class="form-label">Info 1 <span class="text-muted small">(Primary)</span></label>
                            <input type="text" class="form-control" id="info1Template" placeholder="{FirstName} {LastName}">
                            <div class="form-text">Main identifier</div>
                          </div>
                        </div>
                        <div class="col-lg-4">
                          <div class="mb-3">
                            <label for="info2Template" class="form-label">Info 2 <span class="text-muted small">(Secondary)</span></label>
                            <input type="text" class="form-control" id="info2Template" placeholder="{Department}">
                            <div class="form-text">Secondary info</div>
                          </div>
                        </div>
                        <div class="col-lg-4">
                          <div class="mb-3">
                            <label for="info3Template" class="form-label">Info 3 <span class="text-muted small">(Tertiary)</span></label>
                            <input type="text" class="form-control" id="info3Template" placeholder="{Email}">
                            <div class="form-text">Additional info</div>
                          </div>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Available Fields</label>
                        <div id="infoAvailableFields" class="d-flex flex-wrap gap-2"></div>
                      </div>

                      <div class="mb-0">
                        <label class="form-label">Preview</label>
                        <div class="p-3 bg-light border rounded d-flex align-items-center justify-content-center" style="min-height: 150px;">
                          <div class="winner-card-preview" style="position: relative; background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 1.5rem; box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25), 0 5px 15px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: #333; text-align: center; min-width: 200px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div class="winner-number-preview" style="position: absolute; top: -15px; left: -15px; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color, #007bff), var(--secondary-color, #0056b3)); color: white; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; z-index: 10;">1</div>
                            <div class="winner-info1 winner-info1-preview" id="info1Preview" style="font-size: 0.9rem; font-weight: 500; color: #555; margin-bottom: 0.3rem; line-height: 1.1;">John Doe</div>
                            <div class="winner-info2 winner-info2-preview" id="info2Preview" style="font-size: 1.8rem; font-weight: 600; color: #222; margin-bottom: 0.3rem; line-height: 1.1;">Engineering</div>
                            <div class="winner-info3 winner-info3-preview" id="info3Preview" style="font-size: 0.8rem; font-weight: 400; color: #666; line-height: 1.1;">john.doe@company.com</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Navigation Buttons -->
                  <div class="wizard-navigation d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <div class="d-flex gap-2">
                      <button class="btn btn-secondary" id="cancelUpload">
                        <i class="bi bi-x-lg me-1"></i>Cancel
                      </button>
                      <button class="btn btn-outline-primary" @click="document.getElementById('confirmUpload').click()" x-show="step < totalSteps">
                        <i class="bi bi-skip-forward me-1"></i>Use Defaults
                      </button>
                    </div>

                    <div class="d-flex gap-2">
                      <button class="btn btn-outline-secondary" @click="step--" :class="{ 'invisible': step === 1 }">
                        <i class="bi bi-arrow-left me-1"></i>Back
                      </button>
                      <button class="btn btn-primary" @click="step++" x-show="step < totalSteps">
                        Next<i class="bi bi-arrow-right ms-1"></i>
                      </button>
                      <button class="btn btn-success" id="confirmUpload" x-show="step === totalSteps">
                        <i class="bi bi-download me-1"></i>Import Data
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Data Preview Card - Full Width -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card" id="dataPreviewCard" style="display: none;">
              <div class="card-body">
                <h5 class="card-title">Data Preview</h5>
                <div class="table-responsive">
                  <table class="table table-sm" id="previewTable">
                    <thead id="previewHeaders"></thead>
                    <tbody id="previewBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Prizes Tab -->
      <div class="tab-pane fade" id="prizes" role="tabpanel" x-data>
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title mb-0">Prize Management</h5>
              <!-- Sort Controls -->
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn"
                        :class="$store.prizes.sortField === 'name' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="$store.prizes.sortField = 'name'; $store.prizes.sortDir = $store.prizes.sortDir === 'asc' ? 'desc' : 'asc'">
                  Name <i class="bi" :class="$store.prizes.sortField === 'name' ? ($store.prizes.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : ''"></i>
                </button>
                <button type="button" class="btn"
                        :class="$store.prizes.sortField === 'quantity' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="$store.prizes.sortField = 'quantity'; $store.prizes.sortDir = $store.prizes.sortDir === 'asc' ? 'desc' : 'asc'">
                  Quantity <i class="bi" :class="$store.prizes.sortField === 'quantity' ? ($store.prizes.sortDir === 'asc' ? 'bi-sort-numeric-down' : 'bi-sort-numeric-up') : ''"></i>
                </button>
                <button type="button" class="btn"
                        :class="$store.prizes.sortField === 'date' ? 'btn-primary' : 'btn-outline-secondary'"
                        @click="$store.prizes.sortField = 'date'; $store.prizes.sortDir = $store.prizes.sortDir === 'asc' ? 'desc' : 'asc'">
                  Date <i class="bi" :class="$store.prizes.sortField === 'date' ? ($store.prizes.sortDir === 'asc' ? 'bi-sort-down' : 'bi-sort-up') : ''"></i>
                </button>
              </div>
              <button class="btn btn-primary" id="addPrizeModalBtn">
                <i class="bi bi-plus-circle me-2"></i>Add
              </button>
            </div>
            <!-- Prizes Grid -->
            <div class="row g-4 mt-2" id="prizesGrid">
              <template x-for="prize in $store.prizes.sorted" :key="prize.prizeId">
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 prize-card"
                       :class="{ 'border-selected': $store.setup.selectedPrizeId === prize.prizeId }">
                    <div class="card-header">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-truncate" x-text="prize.name" style="max-width: 230px;"></h6>
                        <div>
                          <span class="badge badge-selection me-1" x-show="$store.setup.selectedPrizeId === prize.prizeId">
                            <i class="bi bi-check-circle-fill"></i>
                          </span>
                          <span class="badge bg-secondary" x-text="prize.quantity"></span>
                        </div>
                      </div>
                    </div>
                    <div class="card-body d-flex flex-column">
                      <p class="card-text text-muted small mb-2" x-show="prize.description" x-text="prize.description"></p>
                      <p class="card-text text-muted small mb-2">
                        Added <span x-text="new Date(prize.timestamp).toLocaleDateString()"></span>
                      </p>
                      <div class="mt-auto pt-2">
                        <div class="d-flex justify-content-between align-items-center">
                          <button class="btn btn-sm"
                                  :class="$store.setup.selectedPrizeId === prize.prizeId ? 'btn-selection' : 'btn-outline-selection'"
                                  @click="$store.setup.selectedPrizeId = prize.prizeId">
                            <i :class="$store.setup.selectedPrizeId === prize.prizeId ? 'bi bi-check-circle-fill' : 'bi bi-check-circle'"></i>
                            <span x-text="$store.setup.selectedPrizeId === prize.prizeId ? 'Selected' : 'Select'"></span>
                          </button>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" @click="Prizes.editPrizeModal(prize.prizeId)" title="Edit prize">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" @click="Prizes.deletePrizeConfirm(prize.prizeId)" title="Delete prize">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <!-- Empty state -->
            <div id="noPrizesMessage" class="text-center py-5" x-show="$store.data.prizes.length === 0">
              <i class="bi bi-gift display-1 text-muted"></i>
              <p class="text-muted mt-3">No prizes added yet</p>
            </div>
          </div>
        </div>
      </div>
      <!-- Templates Tab -->
      <div class="tab-pane fade" id="templates" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title mb-0">SMS Templates</h5>
              <button class="btn btn-primary" id="addTemplateBtn">
                <i class="bi bi-plus-circle me-2"></i>Add
              </button>
            </div>
            
            <div id="templatesGrid" class="row g-3 mb-4">
              <!-- Templates will be loaded here -->
            </div>

            <div class="alert alert-info" id="templatePlaceholders">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Available placeholders:</strong>
              <span id="placeholdersList">Loading...</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Winners Tab -->
      <div class="tab-pane fade" id="winners" role="tabpanel" x-data="winnerHelpers">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">All Winners</h5>
              <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-gear me-2"></i>Actions
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="#" id="checkSMSStatusBtn" title="Check SMS delivery status for all pending messages">
                      <i class="bi bi-arrow-clockwise me-2"></i>Check SMS Status
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" id="exportWinnersBtn">
                      <i class="bi bi-download me-2"></i>Export CSV
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger" href="#" id="clearWinnersBtn">
                      <i class="bi bi-trash me-2"></i>Clear All
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-12">
                <label class="form-label">Filters</label>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md">
                <select id="filterPrize" class="form-select form-select-sm"
                        x-model="$store.winners.filterPrize">
                  <option value="">All Prizes</option>
                  <template x-for="prize in $store.winners.uniquePrizes" :key="prize">
                    <option :value="prize" x-text="prize" :selected="prize === $store.winners.filterPrize"></option>
                  </template>
                </select>
              </div>
              <div class="col-md">
                <select id="filterList" class="form-select form-select-sm"
                        x-model="$store.winners.filterList">
                  <option value="">All Lists</option>
                  <template x-for="list in $store.winners.uniqueLists" :key="list">
                    <option :value="list" x-text="list" :selected="list === $store.winners.filterList"></option>
                  </template>
                </select>
              </div>
              <div class="col-md">
                <select id="filterSelection" class="form-select form-select-sm"
                        x-model="$store.winners.filterBatch">
                  <option value="">All Batches</option>
                  <template x-for="batch in $store.winners.uniqueBatches" :key="batch.id">
                    <option :value="batch.id" x-text="batch.label" :selected="batch.id === $store.winners.filterBatch"></option>
                  </template>
                </select>
              </div>
              <div class="col-md">
                <input type="date" id="filterDate" class="form-control form-control-sm"
                       x-model="$store.winners.filterDate">
              </div>
              <div class="col-md-auto">
                <button class="btn btn-sm btn-outline-secondary"
                        @click="$store.winners.clearFilters()">
                  <i class="bi bi-x-circle me-1"></i>Clear All
                </button>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="text-muted">
                <small id="winnersCount" x-text="'Showing ' + $store.winners.filtered.length + ' of ' + $store.data.winners.length + ' winners'">Showing 0 winners</small>
              </div>
              <div class="text-muted">
                <small>
                  <span id="filterStatus"></span>
                </small>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th class="sortable-header" @click="$store.winners.toggleSort('name')">
                      Name
                      <i class="bi" :class="$store.winners.sortField === 'name' ? ($store.winners.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.winners.toggleSort('prize')">
                      Prize
                      <i class="bi" :class="$store.winners.sortField === 'prize' ? ($store.winners.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.winners.toggleSort('date')">
                      Date
                      <i class="bi" :class="$store.winners.sortField === 'date' ? ($store.winners.sortDir === 'asc' ? 'bi-sort-down' : 'bi-sort-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.winners.toggleSort('list')">
                      List
                      <i class="bi" :class="$store.winners.sortField === 'list' ? ($store.winners.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.winners.toggleSort('pickup')">
                      Pickup
                      <i class="bi" :class="$store.winners.sortField === 'pickup' ? ($store.winners.sortDir === 'asc' ? 'bi-sort-down' : 'bi-sort-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.winners.toggleSort('sms')">
                      SMS
                      <i class="bi" :class="$store.winners.sortField === 'sms' ? ($store.winners.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="winnersTableBody">
                  <template x-for="winner in $store.winners.filtered" :key="winner.winnerId">
                    <tr>
                      <td><span class="badge bg-primary winner-id-badge" x-text="getOrderId(winner)"></span></td>
                      <td x-text="winner.displayName"></td>
                      <td x-text="winner.prize"></td>
                      <td x-text="new Date(winner.timestamp).toLocaleDateString()"></td>
                      <td x-text="winner.listName || 'Unknown'"></td>
                      <td>
                        <span :class="winner.pickedUp ? 'badge bg-success' : 'badge bg-warning'">
                          <i :class="winner.pickedUp ? 'bi bi-check-circle-fill' : 'bi bi-clock'"></i>
                          <span x-text="winner.pickedUp ? ' Picked up' : ' Pending'"></span>
                        </span>
                      </td>
                      <td>
                        <span :class="getSmsStatus(winner).class">
                          <i :class="getSmsStatus(winner).icon"></i>
                          <span x-text="' ' + getSmsStatus(winner).text"></span>
                        </span>
                      </td>
                      <td class="py-1">
                        <div class="btn-group btn-group-sm" role="group">
                          <button class="btn btn-sm btn-outline-info" title="Return to List"
                                  @click="Winners.returnToList(winner.winnerId)">
                            <i class="bi bi-arrow-return-left"></i>
                          </button>
                          <button class="btn btn-sm"
                                  :class="winner.pickedUp ? 'btn-outline-secondary' : 'btn-outline-success'"
                                  :title="winner.pickedUp ? 'Mark as Pending' : 'Mark as Picked Up'"
                                  @click="$store.winners.togglePickup(winner.winnerId)">
                            <i class="bi" :class="winner.pickedUp ? 'bi-x-circle' : 'bi-check-circle'"></i>
                          </button>
                          <button class="btn btn-sm btn-outline-danger" title="Delete"
                                  @click="Winners.deleteWinnerConfirm(winner.winnerId)">
                            <i class="bi bi-trash"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </template>
                  <!-- Empty state -->
                  <tr x-show="$store.winners.filtered.length === 0">
                    <td colspan="9" class="text-center text-muted">No winners match the current filters.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- History Tab -->
      <div class="tab-pane fade" id="history" role="tabpanel" x-data>
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Selection History & Statistics</h5>
            <div class="history-stats" id="historyStats">
              <div class="stat-card">
                <div class="stat-number" id="totalSelections" x-text="$store.history.stats.totalSelections">0</div>
                <div class="stat-label">Total Selections</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalWinners" x-text="$store.data.winners.length">0</div>
                <div class="stat-label">Total Winners</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="averageWinners" x-text="$store.data.history.length > 0 ? Math.round($store.data.winners.length / $store.data.history.length * 10) / 10 : 0">0</div>
                <div class="stat-label">Avg Winners/Selection</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="mostUsedPrize" x-text="$store.history.stats.mostUsedPrize">-</div>
                <div class="stat-label">Most Used Prize</div>
              </div>
            </div>
            <!-- History Filters Row -->
            <div class="row mb-3 g-2">
              <div class="col-md">
                <label class="form-label">Filter by List</label>
                <select class="form-select" id="historyListFilter"
                        x-model="$store.history.filterList">
                  <option value="">All Lists</option>
                  <template x-for="list in $store.history.uniqueLists" :key="list">
                    <option :value="list" x-text="list" :selected="list === $store.history.filterList"></option>
                  </template>
                </select>
              </div>
              <div class="col-md">
                <label class="form-label">Filter by Prize</label>
                <select class="form-select" id="historyPrizeFilter"
                        x-model="$store.history.filterPrize">
                  <option value="">All Prizes</option>
                  <template x-for="prize in $store.history.uniquePrizes" :key="prize">
                    <option :value="prize" x-text="prize" :selected="prize === $store.history.filterPrize"></option>
                  </template>
                </select>
              </div>
              <div class="col-md">
                <label class="form-label">Filter by Date</label>
                <input type="date" class="form-control" id="historyDateFilter"
                       x-model="$store.history.filterDate">
              </div>
              <div class="col-md-auto d-flex align-items-end">
                <button class="btn btn-outline-secondary"
                        @click="$store.history.clearFilters()"
                        :disabled="!$store.history.filterList && !$store.history.filterPrize && !$store.history.filterDate">
                  <i class="bi bi-x-circle"></i> Clear All
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th class="sortable-header" @click="$store.history.toggleSort('date')">
                      Date
                      <i class="bi" :class="$store.history.sortField === 'date' ? ($store.history.sortDir === 'asc' ? 'bi-sort-down' : 'bi-sort-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.history.toggleSort('list')">
                      List
                      <i class="bi" :class="$store.history.sortField === 'list' ? ($store.history.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.history.toggleSort('prize')">
                      Prize
                      <i class="bi" :class="$store.history.sortField === 'prize' ? ($store.history.sortDir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th class="sortable-header" @click="$store.history.toggleSort('count')">
                      Count
                      <i class="bi" :class="$store.history.sortField === 'count' ? ($store.history.sortDir === 'asc' ? 'bi-sort-numeric-down' : 'bi-sort-numeric-up') : 'bi-chevron-expand'"></i>
                    </th>
                    <th>Winners</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody">
                  <template x-for="entry in $store.history.sorted" :key="entry.historyId">
                    <tr>
                      <td x-text="new Date(entry.timestamp).toLocaleDateString()"></td>
                      <td x-text="entry.listName || 'Unknown'"></td>
                      <td x-text="entry.prize"></td>
                      <td x-text="entry.winners.length"></td>
                      <td x-text="entry.winners.map(w => w.displayName).join(', ')"></td>
                      <td>
                        <button class="btn btn-sm btn-outline-danger"
                                @click="deleteHistoryConfirm(entry.historyId)">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </template>
                  <!-- Empty state -->
                  <tr x-show="$store.data.history.length === 0">
                    <td colspan="6" class="text-center text-muted">No selection history yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- Queries Tab -->
      <div class="tab-pane fade" id="queries" role="tabpanel" x-data="{
        queries: [],
        loading: false,
        showModal: false,
        editingQuery: null,
        isEditing: false,
        async loadQueries() {
          this.loading = true;
          try {
            const response = await fetch('/api/mp/queries');
            const result = await response.json();
            if (result.success) {
              this.queries = result.queries;
            }
          } catch (error) {
            console.error('Error loading queries:', error);
          } finally {
            this.loading = false;
          }
        },
        async deleteQuery(id) {
          if (!confirm('Are you sure you want to delete this query?')) return;
          try {
            const response = await fetch('/api/mp/queries/' + id, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
              await this.loadQueries();
              UI.showToast('Query deleted', 'success');
            } else {
              UI.showToast(result.error || 'Failed to delete query', 'error');
            }
          } catch (error) {
            console.error('Error deleting query:', error);
            UI.showToast('Error deleting query', 'error');
          }
        },
        openEdit(query) {
          this.editingQuery = JSON.parse(JSON.stringify(query));
          if (!this.editingQuery.metadata) {
            this.editingQuery.metadata = { category: '', previewFields: [] };
          }
          this.isEditing = true;
          this.newParamKeys = [];
          this.showModal = true;
        },
        openNew() {
          this.editingQuery = {
            id: '',
            name: '',
            description: '',
            table: 'Event_Participants',
            select: '',
            filter: '',
            params: {},
            metadata: { category: 'Events', previewFields: [] }
          };
          this.isEditing = false;
          this.newParamKeys = [];
          this.showModal = true;
        },
        closeModal() {
          this.showModal = false;
          this.editingQuery = null;
          this.newParamKeys = [];
        },
        async saveQuery() {
          if (!this.editingQuery.id || !this.editingQuery.name) {
            UI.showToast('ID and Name are required', 'warning');
            return;
          }
          try {
            const method = this.isEditing ? 'PUT' : 'POST';
            const url = this.isEditing ? '/api/mp/queries/' + this.editingQuery.id : '/api/mp/queries';

            const response = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.editingQuery)
            });
            const result = await response.json();
            if (result.success) {
              await this.loadQueries();
              this.closeModal();
              UI.showToast('Query saved', 'success');
            } else {
              UI.showToast(result.error || 'Failed to save query', 'error');
            }
          } catch (error) {
            console.error('Error saving query:', error);
            UI.showToast('Error saving query', 'error');
          }
        },
        newParamKeys: [],
        getParamKeys() {
          return this.editingQuery?.params ? Object.keys(this.editingQuery.params) : [];
        },
        addParam() {
          if (!this.editingQuery.params) this.editingQuery.params = {};
          let name = 'param';
          let i = 1;
          while (this.editingQuery.params[name + i]) i++;
          name = name + i;
          this.editingQuery.params[name] = {
            type: 'number',
            label: '',
            required: true
          };
          this.newParamKeys.push(name);
        },
        isNewParam(key) {
          return this.newParamKeys.includes(key);
        },
        renameParam(oldKey, newKey) {
          newKey = newKey.trim();
          if (!newKey || newKey === oldKey) return;
          if (this.editingQuery.params[newKey]) {
            UI.showToast('Parameter name already exists', 'warning');
            return;
          }
          const value = this.editingQuery.params[oldKey];
          delete this.editingQuery.params[oldKey];
          this.editingQuery.params[newKey] = value;
          const idx = this.newParamKeys.indexOf(oldKey);
          if (idx > -1) this.newParamKeys[idx] = newKey;
        },
        removeParam(key) {
          if (this.editingQuery?.params) {
            const { [key]: _, ...rest } = this.editingQuery.params;
            this.editingQuery.params = rest;
            this.newParamKeys = this.newParamKeys.filter(k => k !== key);
          }
        }
      }" x-init="loadQueries()">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">MP Queries</h5>
              <button class="btn btn-primary" @click="openNew()">
                <i class="bi bi-plus-lg me-2"></i>Add Query
              </button>
            </div>

            <div x-show="loading" class="text-center py-4">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>

            <div class="table-responsive" x-show="!loading">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Table</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="query in queries" :key="query.id">
                    <tr>
                      <td>
                        <strong x-text="query.name"></strong>
                        <br>
                        <small class="text-muted" x-text="query.id"></small>
                      </td>
                      <td x-text="query.description"></td>
                      <td><span class="badge bg-secondary" x-text="query.category || 'Other'"></span></td>
                      <td><code x-text="query.table || '-'"></code></td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-primary me-1" @click="openEdit(query)" title="Edit">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @click="deleteQuery(query.id)" title="Delete">
                          <i class="bi bi-trash"></i>
                        </button>
                      </td>
                    </tr>
                  </template>
                  <tr x-show="queries.length === 0 && !loading">
                    <td colspan="5" class="text-center text-muted">No queries configured yet.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Query Form Modal (Pure Alpine) -->
        <template x-teleport="body">
          <div x-show="showModal" x-cloak @keydown.escape.window="showModal && closeModal()">
            <div class="modal-backdrop show" @click="closeModal()"></div>
            <div class="modal show" style="display: block;" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" x-text="isEditing ? 'Edit Query' : 'New Query'"></h5>
                    <button type="button" class="btn-close" @click="closeModal()"></button>
                  </div>
                  <div class="modal-body">
                    <template x-if="editingQuery">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">ID <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" x-model="editingQuery.id"
                                 placeholder="e.g., my-custom-query"
                                 :disabled="isEditing">
                          <div class="form-text">Lowercase letters, numbers, and hyphens only</div>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Name <span class="text-danger">*</span></label>
                          <input type="text" class="form-control" x-model="editingQuery.name" placeholder="e.g., My Custom Query">
                        </div>
                        <div class="col-12">
                          <label class="form-label">Description</label>
                          <input type="text" class="form-control" x-model="editingQuery.description" placeholder="Brief description of the query">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Table</label>
                          <input type="text" class="form-control" x-model="editingQuery.table" placeholder="e.g., Event_Participants">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Category</label>
                          <input type="text" class="form-control" x-model="editingQuery.metadata.category" placeholder="e.g., Events">
                        </div>
                        <div class="col-12">
                          <label class="form-label">Select Fields</label>
                          <textarea class="form-control font-monospace" rows="3" x-model="editingQuery.select"
                                    placeholder="e.g., Contact_ID, First_Name, Last_Name"></textarea>
                        </div>
                        <div class="col-12">
                          <label class="form-label">Filter (WHERE clause)</label>
                          <textarea class="form-control font-monospace" rows="3" x-model="editingQuery.filter"
                                    placeholder="e.g., Event_ID IN ({{eventId}}) AND Status = 1"></textarea>
                          <div class="form-text">Use {{paramName}} for dynamic parameters</div>
                        </div>
                        <!-- Parameters Section -->
                        <div class="col-12">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">Parameters</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" @click="addParam()">
                              <i class="bi bi-plus-lg me-1"></i>Add
                            </button>
                          </div>
                          <div class="border rounded p-2" x-show="getParamKeys().length > 0">
                            <!-- Header row -->
                            <div class="row g-2 mb-2 text-muted small fw-bold">
                              <div class="col-3">Name</div>
                              <div class="col-3">Label</div>
                              <div class="col-2">Type</div>
                              <div class="col-2">Default</div>
                              <div class="col-2"></div>
                            </div>
                            <template x-for="key in getParamKeys()" :key="key">
                              <div class="row g-2 mb-2 align-items-center">
                                <div class="col-3">
                                  <code class="text-primary" x-show="!isNewParam(key)" x-text="'{{' + key + '}}'"></code>
                                  <input type="text" class="form-control form-control-sm font-monospace" x-show="isNewParam(key)"
                                         :value="key" @change="renameParam(key, $event.target.value)" placeholder="name">
                                </div>
                                <div class="col-3">
                                  <input type="text" class="form-control form-control-sm"
                                         x-show="editingQuery.params[key]"
                                         :value="editingQuery.params[key]?.label || ''"
                                         @input="if(editingQuery.params[key]) editingQuery.params[key].label = $event.target.value"
                                         placeholder="Label">
                                </div>
                                <div class="col-2">
                                  <select class="form-select form-select-sm" x-show="editingQuery.params[key]"
                                          :value="editingQuery.params[key]?.type || 'number'"
                                          @change="if(editingQuery.params[key]) editingQuery.params[key].type = $event.target.value">
                                    <option value="number">number</option>
                                    <option value="text">text</option>
                                  </select>
                                </div>
                                <div class="col-2">
                                  <input type="text" class="form-control form-control-sm"
                                         x-show="editingQuery.params[key]"
                                         :value="editingQuery.params[key]?.value || ''"
                                         @input="if(editingQuery.params[key]) editingQuery.params[key].value = $event.target.value"
                                         placeholder="Default">
                                </div>
                                <div class="col-2 text-end">
                                  <button type="button" class="btn btn-sm btn-outline-danger" x-show="editingQuery.params[key]" @click="removeParam(key)">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                              </div>
                            </template>
                          </div>
                          <div class="text-muted small" x-show="getParamKeys().length === 0">
                            No parameters defined. Click Add to create one.
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" @click="saveQuery()">
                      <i class="bi bi-check-lg me-2"></i>Save Query
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>
      <!-- Settings Tab -->
      <div class="tab-pane fade" id="settings" role="tabpanel" x-data>
        <div class="row">
          <div class="col-lg-6">
            <!-- Display Settings -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">General Settings</h5>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="preventDuplicates"
                           x-model="$store.settings.preventDuplicates"
                           @change="$store.settings.save('preventDuplicates')">
                    <label class="form-check-label" for="preventDuplicates">
                      Remove winners from source list
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Prevent the same person from winning multiple times"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="preventSamePrize"
                           x-model="$store.settings.preventSamePrize"
                           @change="$store.settings.save('preventSamePrize')">
                    <label class="form-check-label" for="preventSamePrize">
                      Prevent winning same prize twice
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Winners cannot win the same prize multiple times (e.g., can't win Jordans twice)"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="hideEntryCounts"
                           x-model="$store.settings.hideEntryCounts"
                           @change="$store.settings.save('hideEntryCounts')">
                    <label class="form-check-label" for="hideEntryCounts">
                      Hide Entry Counts
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Hide the number of participants in public view"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableDebugLogs"
                           x-model="$store.settings.enableDebugLogs"
                           @change="$store.settings.save('enableDebugLogs')">
                    <label class="form-check-label" for="enableDebugLogs">
                      Enable Debug Logs
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Show detailed console logs for debugging"></i>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <!-- Webhook Settings -->
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title">Webhook Settings</h5>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableWebhook"
                           x-model="$store.settings.enableWebhook"
                           @change="$store.settings.save('enableWebhook')">
                    <label class="form-check-label" for="enableWebhook">
                      Enable Webhook Notifications
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Send HTTP POST requests when winners are selected"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3" id="webhookUrlSection" x-show="$store.settings.enableWebhook" x-transition>
                  <label class="form-label" for="webhookUrl">
                    Webhook URL
                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="URL where winner selection notifications will be sent via POST request"></i>
                  </label>
                  <input type="url" class="form-control" id="webhookUrl" placeholder="https://example.com/webhook"
                         x-model="$store.settings.webhookUrl"
                         @change="$store.settings.save('webhookUrl')">
                  <div class="form-text">Winners data will be sent as JSON in the request body</div>
                </div>
              </div>
            </div>
            <!-- Sound Files Settings -->
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title">Sound Files</h5>
                <div class="mb-3">
                  <label class="form-label">Upload Sound Files</label>
                  <input type="file" class="form-control" id="soundFileInput" accept=".mp3" multiple style="display: none;">
                  <div class="form-text">Click the button below to select and upload MP3 files. All uploaded sounds will be available in all sound selection dropdowns.</div>
                </div>
                <button class="btn btn-primary" id="uploadSoundFilesBtn">
                  <i class="bi bi-upload me-2"></i>Upload Sound Files
                </button>
                <div class="mb-3 mt-3">
                  <label class="form-label">Available Sound Files</label>
                  <div id="soundFilesList" class="d-flex flex-column gap-2">
                    <!-- Sound files will be listed here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <!-- Theme Settings -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Theme & Appearance</h5>
                <div class="mb-3">
                  <label class="form-label">
                    Font Family
                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Choose the main font for the application"></i>
                  </label>
                  <select class="form-select" id="fontFamily"
                          x-model="$store.settings.fontFamily"
                          @change="$store.settings.applyTheme(); $store.settings.save('fontFamily')">
                    <option value="Open Sans">Open Sans</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Inter">Inter</option>
                    <option value="Lato">Lato</option>
                    <option value="Poppins">Poppins</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Theme Colors</label>
                  <div class="row">
                    <div class="col-4">
                      <label class="form-label small">Primary</label>
                      <input type="color" class="form-control color-input" id="primaryColor" value="#6366f1"
                             x-model="$store.settings.primaryColor"
                             @input="$store.settings.applyTheme()"
                             @change="$store.settings.save('primaryColor')">
                    </div>
                    <div class="col-4">
                      <label class="form-label small">Secondary</label>
                      <input type="color" class="form-control color-input" id="secondaryColor" value="#8b5cf6"
                             x-model="$store.settings.secondaryColor"
                             @input="$store.settings.applyTheme()"
                             @change="$store.settings.save('secondaryColor')">
                    </div>
                    <div class="col-4">
                      <label class="form-label small">Selection</label>
                      <input type="color" class="form-control color-input" id="selectionColor" value="#10b981"
                             x-model="$store.settings.selectionColor"
                             @input="$store.settings.applyTheme()"
                             @change="$store.settings.save('selectionColor')">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">
                    Background Type
                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Choose background style for winner display"></i>
                  </label>
                  <select class="form-select" id="backgroundType"
                          x-model="$store.settings.backgroundType"
                          @change="$store.settings.save('backgroundType')">
                    <option value="gradient">Gradient</option>
                    <option value="solid">Solid Color</option>
                    <option value="image">Custom Image</option>
                  </select>
                </div>
                <div class="mb-3" id="backgroundImageUpload" x-show="$store.settings.backgroundType === 'image'" x-transition>
                  <label class="form-label">Background Image</label>
                  
                  <!-- Toggle buttons for selecting or uploading -->
                  <div class="btn-group w-100 mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="selectExistingBtn" @click="Settings.showImageSection('existing')">
                      Select Existing
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="uploadNewBtn" @click="Settings.showImageSection('upload')">
                      Upload New
                    </button>
                  </div>
                  
                  <!-- Existing images gallery -->
                  <div id="selectExistingSection">
                    <div id="existingImagesGallery" class="row g-2">
                      <!-- Images will be populated here -->
                    </div>
                    <p class="text-muted small mt-2">Click an image to select it as background</p>
                  </div>
                  
                  <!-- Upload new image -->
                  <div id="uploadNewSection" style="display: none;">
                    <input type="file" class="form-control" id="backgroundImage" accept="image/*">
                    <small class="text-muted">Upload a new image to use as background</small>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Theme Presets</label>
                  <div class="row g-2">
                    <div class="col-4">
                      <button class="btn btn-outline-primary w-100 theme-preset" data-theme="default">
                        <i class="bi bi-palette me-1"></i>Default
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-success w-100 theme-preset" data-theme="emerald">
                        <i class="bi bi-gem me-1"></i>Emerald
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-danger w-100 theme-preset" data-theme="ruby">
                        <i class="bi bi-diamond me-1"></i>Ruby
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-warning w-100 theme-preset" data-theme="gold">
                        <i class="bi bi-star me-1"></i>Gold
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-info w-100 theme-preset" data-theme="ocean">
                        <i class="bi bi-water me-1"></i>Ocean
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-secondary w-100 theme-preset" data-theme="corporate">
                        <i class="bi bi-building me-1"></i>Corporate
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  </div>
  <!-- Progress Overlay -->
  <div id="progressOverlay" class="progress-overlay" x-show="$store.ui.showProgress" x-cloak>
    <div class="progress-content">
      <h5 id="progressTitle" x-text="$store.ui.progressTitle">Processing...</h5>
      <div class="progress-bar-custom">
        <div class="progress-fill" id="progressFill" :style="{ width: $store.ui.progressPercent + '%' }"></div>
      </div>
      <p id="progressText" x-text="$store.ui.progressText">Please wait...</p>
    </div>
  </div>
  
  <!-- Countdown Animation Overlay -->
  <div class="countdown-animation d-none" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <canvas id="countdownCanvas"></canvas>
  </div>
  <!-- Animation Canvas - outside countdown so it's always available -->
  <canvas id="animationCanvas"></canvas>
  <!-- Pre-Display Delay Overlay -->
  <div class="delay-overlay d-none" id="delayOverlay">
    <div class="delay-content">
      <div id="delaySpinner" class="delay-spinner d-none">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3 text-light">Preparing winners...</div>
      </div>
      <div id="delayCountdown" class="delay-countdown d-none">
        <div class="countdown-circle">
          <span id="delayCountdownNumber">5</span>
        </div>
        <div class="mt-3 text-light">Winners in...</div>
      </div>
      <div id="delayProgress" class="delay-progress d-none">
        <div class="progress-container">
          <div class="progress-bar-delay" id="delayProgressBar"></div>
        </div>
        <div class="mt-3 text-light">Finalizing selection...</div>
      </div>
      <div id="delayDots" class="delay-dots d-none">
        <div class="dots-container">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
        <div class="mt-3 text-light">Getting ready...</div>
      </div>
    </div>
  </div>
  <!-- Hidden file input for restore -->
  <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
  <!-- Confirm Modal (Alpine - for yes/no confirmations) -->
  <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" x-data="confirmModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel" x-text="title">Confirm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmModalBody">
          <p x-text="message"></p>
          <div x-html="customContent" x-show="customContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn" :class="confirmClass" id="confirmModalConfirmBtn" @click="confirm()" x-text="confirmText">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Form Modal (Alpine - for Add/Edit operations) -->
  <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" x-data="formModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="formModalLabel" x-text="title">Form</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="formModalBody">
          <!-- Prize Form -->
          <template x-if="formType === 'prize'">
            <form @submit.prevent="save">
              <div class="mb-3">
                <label for="prizeName" class="form-label">Prize Name <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="prizeName" x-model="formData.name" placeholder="Enter prize name" required>
              </div>
              <div class="mb-3">
                <label for="prizeQuantity" class="form-label">Quantity <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="prizeQuantity" x-model.number="formData.quantity" min="0" required>
              </div>
              <div class="mb-3">
                <label for="prizeWinnersCount" class="form-label">Default Winners Count</label>
                <small class="d-block text-muted">Number of winners to select when this prize is chosen</small>
                <input type="number" class="form-control" id="prizeWinnersCount" x-model.number="formData.winnersCount" min="1" max="100" required>
              </div>
              <div class="mb-3">
                <label for="prizeDescription" class="form-label">Description (Optional)</label>
                <textarea class="form-control" id="prizeDescription" x-model="formData.description" rows="3" placeholder="Enter prize description"></textarea>
              </div>
              <div class="mb-3">
                <label for="prizeTemplate" class="form-label">SMS Template</label>
                <select class="form-select" id="prizeTemplate" x-model="formData.templateId">
                  <option value="">Use default template</option>
                  <template x-for="template in templates" :key="template.templateId">
                    <option :value="template.templateId" x-text="template.name + (template.isDefault ? ' (Default)' : '')"></option>
                  </template>
                </select>
              </div>
            </form>
          </template>

          <!-- Template Form -->
          <template x-if="formType === 'template'">
            <form @submit.prevent="save">
              <div class="mb-3">
                <label for="templateName" class="form-label">Template Name</label>
                <input type="text" class="form-control" id="templateName" x-model="formData.name" required>
              </div>
              <div class="mb-3">
                <label for="templateMessage" class="form-label">Message Template</label>
                <textarea class="form-control" id="templateMessage" x-model="formData.message" rows="8" required></textarea>
                <div class="form-text">
                  <strong>Available placeholders:</strong><br>
                  <span x-text="placeholders.map(p => `{${p}}`).join(', ')"></span>
                </div>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="templateIsDefault" x-model="formData.isDefault">
                <label class="form-check-label" for="templateIsDefault">
                  Set as default template
                </label>
              </div>
            </form>
          </template>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" @click="save" x-text="saveButtonText">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Modal (Alpine - for read-only displays like tables, QR codes) -->
  <div class="modal fade" id="viewModal" tabindex="-1" aria-labelledby="viewModalLabel" x-data="viewModal">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="viewModalLabel" x-text="title">View</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="viewModalBody">
          <!-- List View -->
          <template x-if="contentType === 'list'">
            <div>
              <div class="mb-3" x-show="!hideEntryCounts">
                <strong>Total Entries:</strong> <span x-text="listData.entryCount"></span>
                <span class="text-muted ms-2" x-show="listData.skippedWinners" x-text="'(' + listData.skippedWinners + ' winners skipped during upload)'"></span>
              </div>
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="table table-striped table-sm">
                  <thead class="sticky-top bg-white">
                    <tr>
                      <th style="width: 60px;">#</th>
                      <th>Display Name</th>
                      <template x-for="col in listData.displayColumns" :key="col">
                        <th x-text="col"></th>
                      </template>
                      <th style="width: 80px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    <template x-for="(entry, index) in listData.entries" :key="entry.id || index">
                      <tr>
                        <td x-text="index + 1"></td>
                        <td x-text="entry.displayName"></td>
                        <template x-for="col in listData.displayColumns" :key="col">
                          <td x-text="entry.data?.[col] || ''"></td>
                        </template>
                        <td>
                          <button class="btn btn-sm btn-outline-danger" @click="deleteEntry(entry.id)">
                            <i class="bi bi-trash"></i>
                          </button>
                        </td>
                      </tr>
                    </template>
                    <tr x-show="listData.entries.length === 0">
                      <td :colspan="listData.displayColumns.length + 3" class="text-center text-muted">No entries in this list</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="mt-3 text-muted small">
                <i class="bi bi-info-circle"></i> Individual records can be deleted from this list. This action cannot be undone.
              </div>
            </div>
          </template>

          <!-- SMS Results View -->
          <template x-if="contentType === 'smsResults'">
            <div>
              <div class="alert" :class="smsData.alertClass">
                <h5>Send Complete</h5>
                <p>Success rate: <span x-text="smsData.successRate"></span>%</p>
              </div>
              <div class="row">
                <div class="col-6">
                  <div class="card">
                    <div class="card-body text-center">
                      <h3 class="text-success" x-text="smsData.successCount"></h3>
                      <p class="text-muted">Successful</p>
                    </div>
                  </div>
                </div>
                <div class="col-6">
                  <div class="card">
                    <div class="card-body text-center">
                      <h3 class="text-danger" x-text="smsData.failedCount"></h3>
                      <p class="text-muted">Failed</p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="mt-3" x-show="smsData.failed.length > 0">
                <h6>Failed Recipients:</h6>
                <div class="small" style="max-height: 200px; overflow-y: auto;">
                  <template x-for="f in smsData.failed" :key="f.recipient?.displayName">
                    <div class="text-danger" x-text="(f.recipient?.displayName || 'Unknown') + ': ' + f.error"></div>
                  </template>
                </div>
              </div>
            </div>
          </template>

          <!-- QR Code View -->
          <template x-if="contentType === 'qrCode'">
            <div class="text-center">
              <h5>Ticket Code: <span class="badge bg-primary fs-6" x-text="qrData.ticketCode"></span></h5>
              <img :src="qrData.qrCodeUrl" alt="QR Code" class="img-fluid my-3" />
              <p class="text-muted">Scan this code at the prize pickup station</p>
            </div>
          </template>

          <!-- Custom HTML fallback -->
          <template x-if="contentType === 'custom'">
            <div x-html="customHtml"></div>
          </template>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit List Config Modal -->
  <div class="modal fade" id="editListConfigModal" tabindex="-1" aria-labelledby="editListConfigModalLabel"
       x-data="{ removeWinners: window.settings?.preventDuplicates ?? true, listId: null, listName: '' }">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editListConfigModalLabel">
            <i class="bi bi-gear me-2"></i>Edit List Settings
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-bold">List Name</label>
            <input type="text" class="form-control" id="editListName" x-model="listName">
          </div>
          <hr>
          <h6 class="text-muted mb-3">Winner Behavior Settings</h6>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="editRemoveWinnersFromList"
                   x-model="removeWinners">
            <label class="form-check-label" for="editRemoveWinnersFromList">
              <strong>Remove winners from source list</strong>
            </label>
            <div class="form-text">When enabled, winners are removed from this list so they cannot win again.</div>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="editPreventWinningSamePrize"
                   :checked="!removeWinners" :disabled="!removeWinners">
            <label class="form-check-label" for="editPreventWinningSamePrize">
              <strong>Prevent winning same prize twice</strong>
            </label>
            <div class="form-text">Auto-enabled when keeping winners in list. Prevents same person winning same prize type twice.</div>
          </div>
          <div class="alert alert-info mt-3" x-show="!removeWinners">
            <i class="bi bi-info-circle me-2"></i>Winners will remain in list but cannot win the same prize twice.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" @click="Lists.saveListConfig(listId)">
            <i class="bi bi-check-lg me-2"></i>Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Import Modal -->
  <div class="modal fade" id="reportImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import from Giveaway Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reportImportForm">
            <div class="mb-3">
              <label for="reportType" class="form-label">Report Type</label>
              <select class="form-select" id="reportType" required>
                <option value="">Select a report...</option>
                <option value="export_giveaways_adults_car.sql">Adults - Car Giveaway (License Required)</option>
                <option value="export_giveaways_adults_general.sql">Adults - General Giveaway</option>
                <option value="export_giveaways_minors_over_12.sql">Teens - Over 12</option>
                <option value="export_giveaways_minors_under_12.sql">Kids - Under 12</option>
                <option value="export_giveaways_minors_all.sql">Minors - All Ages</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="eventId" class="form-label">Event ID</label>
              <input type="number" class="form-control" id="eventId" value="19" required>
            </div>
            
            <div class="mb-3">
              <label for="timeRange" class="form-label">Time Range</label>
              <select class="form-select" id="timeRange" required>
                <option value="today">Today (4am to now)</option>
                <option value="morning">Morning (4am - 3pm CDT)</option>
                <option value="night">Night (3pm - 4am CDT)</option>
                <option value="last5">Last 5 Hours</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            
            <div id="customTimeRange" class="d-none">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="customStart" class="form-label">Start Time</label>
                  <input type="datetime-local" class="form-control" id="customStart">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="customEnd" class="form-label">End Time</label>
                  <input type="datetime-local" class="form-control" id="customEnd">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="listName" class="form-label">List Name</label>
              <input type="text" class="form-control" id="reportListName" placeholder="e.g., Morning Car Giveaway" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="importReportBtn">
            <i class="bi bi-download me-2"></i>Import Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MinistryPlatform Import Modal -->
  <div class="modal fade" id="mpImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import from Ministry Platform</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="mpImportForm">
            <!-- Query Selection -->
            <div class="mb-3">
              <label for="mpQuerySelect" class="form-label">Select Query</label>
              <select class="form-select" id="mpQuerySelect" required>
                <option value="">Loading queries...</option>
              </select>
              <div class="form-text" id="mpQueryDescription"></div>
            </div>
            
            <!-- Dynamic Parameters -->
            <div id="mpParametersSection" style="display: none;">
              <h6 class="mb-3">Query Parameters</h6>
              <div id="mpParametersContainer"></div>
            </div>
            
            <!-- Preview Section -->
            <div id="mpPreviewSection" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Preview</h6>
                <span class="badge bg-primary" id="mpRecordCount">0 records</span>
              </div>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-striped" id="mpPreviewTable">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            
            <!-- List Name -->
            <div class="mb-3 mt-3">
              <label for="mpListName" class="form-label">List Name</label>
              <input type="text" class="form-control" id="mpListName" placeholder="e.g., Youth Group Members" required>
            </div>
            
            <!-- Error Display -->
            <div class="alert alert-danger" id="mpErrorAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="mpImportBtn" style="display: none;">
            <i class="bi bi-gear me-2"></i>Configure Import
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script>
    // Suppress Bootstrap's known JSON parsing bug for tabs and dropdowns
    // This is a known issue in Bootstrap 5.3.x that doesn't affect functionality
    const originalParse = JSON.parse;
    JSON.parse = function(text) {
      // Bootstrap tries to parse "tab", "dropdown" and "#selector" as JSON, which fails
      // but doesn't break functionality - just suppress these specific errors
      if (text === 'tab' || text === 'tooltip' || text === 'dropdown' || (typeof text === 'string' && text.startsWith('#'))) {
        return {};
      }
      return originalParse.apply(this, arguments);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Toastify JS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Alpine.js Persist Plugin (loads and executes first, registers $persist) -->
  <script src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.15.2/dist/cdn.min.js"></script>

  <!-- TODO: Bootstrap nested modal scroll fix - TEMPORARY WORKAROUND
       Issue: Bootstrap 5.3 ScrollBarHelper JSON.parse error with nested modals.
       Proper fix: Avoid nested modals OR upgrade Bootstrap when fixed.
       See: https://getbootstrap.com/docs/5.3/components/modal/#how-it-works -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const _bodyGetAttr = document.body.getAttribute.bind(document.body);
      document.body.getAttribute = function(name) {
        const value = _bodyGetAttr(name);
        if ((name === 'data-bs-overflow' || name === 'data-bs-padding-right') && value) {
          return JSON.stringify(value);
        }
        return value;
      };
    });
  </script>

  <!-- Alpine.js Store Registration - must be AFTER persist plugin -->
  <script>
    document.addEventListener('alpine:init', () => {
      // Settings store with persistence
      Alpine.store('settings', {
        // General settings
        preventDuplicates: Alpine.$persist(false).as('settings_preventDuplicates'),
        preventSamePrize: Alpine.$persist(false).as('settings_preventSamePrize'),
        hideEntryCounts: Alpine.$persist(false).as('settings_hideEntryCounts'),
        enableDebugLogs: Alpine.$persist(false).as('settings_enableDebugLogs'),
        enableWebhook: Alpine.$persist(false).as('settings_enableWebhook'),
        webhookUrl: Alpine.$persist('').as('settings_webhookUrl'),

        // Theme settings
        fontFamily: Alpine.$persist('Open Sans').as('settings_fontFamily'),
        primaryColor: Alpine.$persist('#6366f1').as('settings_primaryColor'),
        secondaryColor: Alpine.$persist('#8b5cf6').as('settings_secondaryColor'),
        selectionColor: Alpine.$persist('#10b981').as('settings_selectionColor'),
        backgroundType: Alpine.$persist('gradient').as('settings_backgroundType'),
        customBackgroundImage: Alpine.$persist(null).as('settings_customBackgroundImage'),

        // Selection display settings
        selectionMode: Alpine.$persist('all-at-once').as('settings_selectionMode'),
        displayEffect: Alpine.$persist('fade-in').as('settings_displayEffect'),
        displayDuration: Alpine.$persist(0.5).as('settings_displayDuration'),
        stableGrid: Alpine.$persist(false).as('settings_stableGrid'),
        preSelectionDelay: Alpine.$persist(0).as('settings_preSelectionDelay'),
        delayVisualType: Alpine.$persist('none').as('settings_delayVisualType'),

        // Sound settings
        soundDuringDelay: Alpine.$persist('none').as('settings_soundDuringDelay'),
        soundEndOfDelay: Alpine.$persist('none').as('settings_soundEndOfDelay'),
        soundDuringReveal: Alpine.$persist('none').as('settings_soundDuringReveal'),

        // Celebration settings
        celebrationEffect: Alpine.$persist('confetti').as('settings_celebrationEffect'),
        celebrationDuration: Alpine.$persist(4).as('settings_celebrationDuration'),
        celebrationAutoTrigger: Alpine.$persist(true).as('settings_celebrationAutoTrigger'),

        // SMS Template
        smsTemplate: Alpine.$persist('Congratulations {name}! You won {prize}. Your code: {contactId}').as('settings_smsTemplate'),

        init() {
          // Sync with backend on load (non-blocking)
          this.loadFromServer();
        },

        async loadFromServer() {
          // Bridge to existing database.js - will be implemented after module loads
        },

        async save(key) {
          // Bridge to existing Settings.saveSingleSetting() - will be connected after module loads
          if (window.Settings && window.Settings.saveSingleSetting) {
            await window.Settings.saveSingleSetting(key, this[key]);
          }
        },

        applyTheme() {
          // Apply CSS variables for live preview
          document.documentElement.style.setProperty('--bs-primary', this.primaryColor);
          document.documentElement.style.setProperty('--color-primary', this.primaryColor);
          document.documentElement.style.setProperty('--color-secondary', this.secondaryColor);
          document.documentElement.style.setProperty('--selection-color', this.selectionColor);
          document.documentElement.style.setProperty('--font-family', this.fontFamily);
          document.body.style.fontFamily = `'${this.fontFamily}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`;
        }
      });

      // Quick setup state with Alpine.$persist for automatic localStorage sync
      Alpine.store('setup', {
        selectedListIds: Alpine.$persist([]).as('setup_selectedListIds'),
        selectedPrizeId: Alpine.$persist('').as('setup_selectedPrizeId'),
        winnersCount: Alpine.$persist(1).as('setup_winnersCount'),

        // Computed eligible entries - calculated on-demand as a getter
        get eligibleEntries() {
          const result = this._computeEligibility();
          return result.eligible;
        },

        get excludedCount() {
          const result = this._computeEligibility();
          return result.excluded;
        },

        // Internal method to compute eligibility (called by getters)
        _computeEligibility() {
          const dataStore = Alpine.store('data');
          const settingsStore = Alpine.store('settings');

          if (!dataStore || !settingsStore) {
            return { eligible: 0, excluded: 0 };
          }

          // Calculate total entries from selected lists
          let total = this.selectedListIds.reduce((sum, listId) => {
            const list = dataStore.lists?.find(l => l.listId === listId);
            return sum + (list?.entries?.length || 0);
          }, 0);

          let excluded = 0;

          // If preventSamePrize is enabled and a prize is selected, calculate exclusions
          if (settingsStore.preventSamePrize && this.selectedPrizeId) {
            const prize = dataStore.prizes?.find(p => p.prizeId === this.selectedPrizeId);
            const prizeName = prize?.name;

            if (prizeName && dataStore.winners) {
              const samePrizeWinnerEntryIds = new Set(
                dataStore.winners
                  .filter(w => w.prize === prizeName)
                  .map(w => w.entryId)
                  .filter(Boolean)
              );

              if (samePrizeWinnerEntryIds.size > 0) {
                let eligible = 0;
                for (const listId of this.selectedListIds) {
                  const list = dataStore.lists?.find(l => l.listId === listId);
                  if (list?.entries) {
                    for (const entry of list.entries) {
                      const entryId = entry.id || entry.data?.['Ticket Code'] || entry.data?.ticketCode;
                      if (!entryId || !samePrizeWinnerEntryIds.has(entryId)) {
                        eligible++;
                      } else {
                        excluded++;
                      }
                    }
                  }
                }
                total = eligible;
              }
            }
          }

          return { eligible: total, excluded };
        },

        init() {
          // Effect only for auto-capping winnersCount when limits change
          Alpine.effect(() => {
            const eligible = this.eligibleEntries;
            const prizeQty = this.selectedPrizeQuantity;

            // Cap to eligibleEntries if exceeded
            if (eligible > 0 && this.winnersCount > eligible) {
              this.winnersCount = eligible;
            }

            // Cap to prize quantity if exceeded
            if (prizeQty !== null && this.winnersCount > prizeQty) {
              this.winnersCount = prizeQty;
            }
          });
        },

        // Cap winnersCount to not exceed eligibleEntries or prizeQuantity
        capWinnersCount() {
          const eligible = this.eligibleEntries;
          // Cap to eligibleEntries if exceeded (and entries exist)
          if (eligible > 0 && this.winnersCount > eligible) {
            this.winnersCount = eligible;
          }
          // Cap to prize quantity if exceeded (and quantity is set)
          const prizeQty = this.selectedPrizeQuantity;
          if (prizeQty !== null && this.winnersCount > prizeQty) {
            this.winnersCount = prizeQty;
          }
        },

        // Called when prize selection changes - updates winnersCount from prize default
        onPrizeChange() {
          const dataStore = Alpine.store('data');
          if (this.selectedPrizeId && dataStore?.prizes) {
            const prize = dataStore.prizes.find(p => p.prizeId === this.selectedPrizeId);
            if (prize?.winnersCount) {
              this.winnersCount = prize.winnersCount;
            }
          }
          this.capWinnersCount();
        },

        get canStart() {
          return this.selectedListIds.length > 0 && this.selectedPrizeId;
        },

        get listDisplayText() {
          const dataStore = Alpine.store('data');
          if (!dataStore || !dataStore.lists) return 'Not Selected';
          if (this.selectedListIds.length === 0) return 'Not Selected';
          if (this.selectedListIds.length === 1) {
            const list = dataStore.lists.find(l => l.listId === this.selectedListIds[0]);
            return list?.metadata?.name || 'Unknown';
          }
          return `${this.selectedListIds.length} Lists Selected`;
        },

        get prizeDisplayText() {
          const dataStore = Alpine.store('data');
          if (!dataStore || !dataStore.prizes) return 'Not Selected';
          if (!this.selectedPrizeId) return 'Not Selected';
          const prize = dataStore.prizes.find(p => p.prizeId === this.selectedPrizeId);
          return prize?.name || 'Not Selected';
        },

        get selectedPrizeQuantity() {
          const dataStore = Alpine.store('data');
          if (!dataStore?.prizes || !this.selectedPrizeId) return null;
          const prize = dataStore.prizes.find(p => p.prizeId === this.selectedPrizeId);
          return prize?.quantity ?? null;
        },

        get entriesExceeded() {
          if (this.selectedListIds.length === 0) return false;
          return this.winnersCount > this.eligibleEntries;
        },

        get prizeQuantityExceeded() {
          const qty = this.selectedPrizeQuantity;
          if (qty === null) return false;
          return this.winnersCount > qty;
        },

        get hasValidationWarning() {
          return this.entriesExceeded || this.prizeQuantityExceeded;
        },

        get validSelectedCount() {
          const dataStore = Alpine.store('data');
          if (!dataStore?.lists) return 0;
          const validIds = dataStore.lists.map(l => l.listId);
          return this.selectedListIds.filter(id => validIds.includes(id)).length;
        },

        isListSelected(listId) {
          return this.selectedListIds.includes(listId);
        },

        toggleList(listId) {
          if (this.selectedListIds.includes(listId)) {
            this.selectedListIds = this.selectedListIds.filter(id => id !== listId);
          } else {
            this.selectedListIds = [...this.selectedListIds, listId];
          }
          this.capWinnersCount(); // Cap immediately after list change
        },

        selectList(listId) {
          if (!this.selectedListIds.includes(listId)) {
            this.selectedListIds = [...this.selectedListIds, listId];
          }
          this.capWinnersCount(); // Cap immediately after list change
        },

        deselectList(listId) {
          if (this.selectedListIds.includes(listId)) {
            this.selectedListIds = this.selectedListIds.filter(id => id !== listId);
          }
          this.capWinnersCount(); // Cap immediately after list change
        }
      });

      // ================================
      // CENTRALIZED DATA STORE
      // Single source of truth for all data operations
      // ================================
      Alpine.store('data', {
        lists: [],
        prizes: [],
        winners: [],
        history: [],
        loading: { lists: false, prizes: false, winners: false, history: false },

        // ID field mapping for each collection
        _idFields: {
          lists: 'listId',
          prizes: 'prizeId',
          winners: 'winnerId',
          history: 'historyId'
        },

        // Generic CRUD Operations
        async load(collection) {
          if (!window.Database) return;
          this.loading[collection] = true;
          try {
            const data = await window.Database.getFromStore(collection);
            this[collection] = data || [];
          } catch (error) {
            console.error(`Error loading ${collection}:`, error);
          } finally {
            this.loading[collection] = false;
          }
        },

        async loadAll() {
          await Promise.all([
            this.load('lists'),
            this.load('prizes'),
            this.load('winners'),
            this.load('history')
          ]);
        },

        async save(collection, item) {
          if (!window.Database) return;
          await window.Database.saveToStore(collection, item);
          await this.load(collection);
        },

        async delete(collection, id) {
          if (!window.Database) return;
          await window.Database.deleteFromStore(collection, id);
          await this.load(collection);
        },

        getById(collection, id) {
          const idField = this._idFields[collection];
          return this[collection].find(item => item[idField] === id);
        }
      });

      // Domain-specific stores (filtering, sorting, computed properties)
      // Reference $store.data for raw items, provide sorting/filtering logic
      Alpine.store('lists', {
        sortField: 'name',
        sortDir: 'asc',

        // Reference centralized data
        get items() { return Alpine.store('data').lists; },
        get loading() { return Alpine.store('data').loading.lists; },

        toggleSort(field) {
          if (this.sortField === field) {
            this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortField = field;
            this.sortDir = 'asc';
          }
        },

        get sorted() {
          return [...this.items].sort((a, b) => {
            let valA, valB;
            switch (this.sortField) {
              case 'name':
                valA = a.metadata?.name?.toLowerCase() || '';
                valB = b.metadata?.name?.toLowerCase() || '';
                break;
              case 'entries':
                valA = a.entries?.length || 0;
                valB = b.entries?.length || 0;
                break;
              case 'date':
                valA = a.metadata?.timestamp || 0;
                valB = b.metadata?.timestamp || 0;
                break;
              default:
                return 0;
            }
            if (valA < valB) return this.sortDir === 'asc' ? -1 : 1;
            if (valA > valB) return this.sortDir === 'asc' ? 1 : -1;
            return 0;
          });
        }
      });

      Alpine.store('prizes', {
        sortField: 'name',
        sortDir: 'asc',
        _sortTrigger: 0,

        // Reference centralized data
        get items() { return Alpine.store('data').prizes; },
        get loading() { return Alpine.store('data').loading.prizes; },

        // Domain-specific operation
        async decrementQuantity(prizeId, amount = 1) {
          const prize = Alpine.store('data').getById('prizes', prizeId);
          if (prize && prize.quantity >= amount) {
            prize.quantity -= amount;
            await Alpine.store('data').save('prizes', prize);
          }
        },

        toggleSort(field) {
          if (this.sortField === field) {
            this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortField = field;
            this.sortDir = 'asc';
          }
          this._sortTrigger++;
        },

        get sorted() {
          const trigger = this._sortTrigger;
          const field = this.sortField;
          const dir = this.sortDir;
          return [...this.items].sort((a, b) => {
            let valA, valB;
            switch (field) {
              case 'name':
                valA = a.name?.toLowerCase() || '';
                valB = b.name?.toLowerCase() || '';
                break;
              case 'quantity':
                valA = a.quantity || 0;
                valB = b.quantity || 0;
                break;
              case 'date':
                valA = a.timestamp || 0;
                valB = b.timestamp || 0;
                break;
              default:
                return 0;
            }
            if (valA < valB) return dir === 'asc' ? -1 : 1;
            if (valA > valB) return dir === 'asc' ? 1 : -1;
            return 0;
          });
        },

        get available() {
          return this.items.filter(p => p.quantity > 0);
        }
      });

      Alpine.store('winners', {
        filterPrize: '',
        filterList: '',
        filterBatch: '',
        filterDate: '',
        sortField: 'date',
        sortDir: 'desc',

        // Reference centralized data
        get items() { return Alpine.store('data').winners; },

        init() {
          // Restore filters from localStorage
          this.filterPrize = localStorage.getItem('winners_filter_prize') || '';
          this.filterList = localStorage.getItem('winners_filter_list') || '';
          this.filterBatch = localStorage.getItem('winners_filter_batch') || '';
          this.filterDate = localStorage.getItem('winners_filter_date') || '';

          // Watch for changes and persist
          Alpine.effect(() => {
            localStorage.setItem('winners_filter_prize', this.filterPrize);
            localStorage.setItem('winners_filter_list', this.filterList);
            localStorage.setItem('winners_filter_batch', this.filterBatch);
            localStorage.setItem('winners_filter_date', this.filterDate);
          });
        },

        // Domain-specific operations
        async togglePickup(winnerId) {
          const winner = Alpine.store('data').getById('winners', winnerId);
          if (winner) {
            winner.pickedUp = !winner.pickedUp;
            if (winner.pickedUp) {
              winner.pickupTimestamp = new Date().toISOString();
              winner.pickupStation = 'Manual';
            } else {
              winner.pickupTimestamp = null;
              winner.pickupStation = null;
            }
            await Alpine.store('data').save('winners', winner);
          }
        },

        async updateSmsStatus(winnerId, status, messageId = null) {
          const winner = Alpine.store('data').getById('winners', winnerId);
          if (winner) {
            winner.sms = { status, messageId, timestamp: Date.now() };
            await Alpine.store('data').save('winners', winner);
          }
        },

        toggleSort(field) {
          if (this.sortField === field) {
            this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortField = field;
            this.sortDir = field === 'date' ? 'desc' : 'asc';
          }
        },

        get filtered() {
          const filtered = this.items.filter(w => {
            if (this.filterPrize && w.prize !== this.filterPrize) return false;
            if (this.filterList && w.listName !== this.filterList) return false;
            if (this.filterBatch && w.historyId !== this.filterBatch) return false;
            if (this.filterDate) {
              const winnerDate = new Date(w.timestamp).toISOString().split('T')[0];
              if (winnerDate !== this.filterDate) return false;
            }
            return true;
          });
          return filtered.sort((a, b) => {
            let valA, valB;
            switch (this.sortField) {
              case 'name': valA = a.displayName?.toLowerCase() || ''; valB = b.displayName?.toLowerCase() || ''; break;
              case 'prize': valA = a.prize?.toLowerCase() || ''; valB = b.prize?.toLowerCase() || ''; break;
              case 'date': valA = a.timestamp || 0; valB = b.timestamp || 0; break;
              case 'list': valA = a.listName?.toLowerCase() || ''; valB = b.listName?.toLowerCase() || ''; break;
              case 'pickup': valA = a.pickedUp ? 1 : 0; valB = b.pickedUp ? 1 : 0; break;
              case 'sms': valA = a.sms?.status?.toLowerCase() || ''; valB = b.sms?.status?.toLowerCase() || ''; break;
              default: valA = a.timestamp || 0; valB = b.timestamp || 0;
            }
            if (valA < valB) return this.sortDir === 'asc' ? -1 : 1;
            if (valA > valB) return this.sortDir === 'asc' ? 1 : -1;
            return 0;
          });
        },

        // Get items filtered by all OTHER filters (for cascading dropdowns)
        getItemsExcludingFilter(excludeFilter) {
          return this.items.filter(w => {
            if (excludeFilter !== 'prize' && this.filterPrize && w.prize !== this.filterPrize) return false;
            if (excludeFilter !== 'list' && this.filterList && w.listName !== this.filterList) return false;
            if (excludeFilter !== 'batch' && this.filterBatch && w.historyId !== this.filterBatch) return false;
            if (excludeFilter !== 'date' && this.filterDate) {
              const winnerDate = new Date(w.timestamp).toISOString().split('T')[0];
              if (winnerDate !== this.filterDate) return false;
            }
            return true;
          });
        },

        // Computed: unique prize names (cascading - based on other active filters)
        get uniquePrizes() {
          const items = this.getItemsExcludingFilter('prize');
          const prizes = [...new Set(items.map(w => w.prize))].sort();
          // Always include currently selected value if it exists
          if (this.filterPrize && !prizes.includes(this.filterPrize)) {
            prizes.unshift(this.filterPrize);
          }
          return prizes;
        },

        // Computed: unique list names (cascading - based on other active filters)
        get uniqueLists() {
          const items = this.getItemsExcludingFilter('list');
          const lists = [...new Set(items.map(w => w.listName || 'Unknown'))].sort();
          // Always include currently selected value if it exists
          if (this.filterList && !lists.includes(this.filterList)) {
            lists.unshift(this.filterList);
          }
          return lists;
        },

        // Computed: unique batches (cascading - based on other active filters)
        get uniqueBatches() {
          const items = this.getItemsExcludingFilter('batch');
          const batches = {};
          items.forEach(w => {
            if (w.historyId && !batches[w.historyId]) {
              batches[w.historyId] = {
                id: w.historyId,
                timestamp: w.timestamp,
                prize: w.prize
              };
            }
          });
          const result = Object.values(batches)
            .sort((a, b) => b.timestamp - a.timestamp)
            .map(b => ({
              id: b.id,
              label: `${new Date(b.timestamp).toLocaleDateString()} - ${b.prize}`
            }));
          // Always include currently selected batch if it exists
          if (this.filterBatch && !result.some(b => b.id === this.filterBatch)) {
            // Find it in all items
            const selectedBatch = this.items.find(w => w.historyId === this.filterBatch);
            if (selectedBatch) {
              result.unshift({
                id: this.filterBatch,
                label: `${new Date(selectedBatch.timestamp).toLocaleDateString()} - ${selectedBatch.prize}`
              });
            }
          }
          return result;
        },

        clearFilters() {
          this.filterPrize = '';
          this.filterList = '';
          this.filterBatch = '';
          this.filterDate = '';
        }
      });

      // History store
      // IMPORTANT: Alpine reactivity doesn't track getter-to-getter dependencies.
      // All filter properties must be accessed DIRECTLY in the getter used by templates,
      // not through intermediate getters. See 'sorted' getter below.
      Alpine.store('history', {
        filterList: '',
        filterPrize: '',
        filterDate: '',
        sortField: 'date',
        sortDir: 'desc',

        // Reference centralized data
        get items() { return Alpine.store('data').history; },

        init() {
          // Restore filters from localStorage
          this.filterList = localStorage.getItem('history_filter_list') || '';
          this.filterPrize = localStorage.getItem('history_filter_prize') || '';
          this.filterDate = localStorage.getItem('history_filter_date') || '';

          // Persist filters to localStorage on change
          Alpine.effect(() => {
            localStorage.setItem('history_filter_list', this.filterList);
            localStorage.setItem('history_filter_prize', this.filterPrize);
            localStorage.setItem('history_filter_date', this.filterDate);
          });
        },

        toggleSort(field) {
          if (this.sortField === field) {
            this.sortDir = this.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            this.sortField = field;
            this.sortDir = field === 'date' ? 'desc' : 'asc';
          }
        },

        get sorted() {
          // IMPORTANT: Access ALL filter properties DIRECTLY here for proper Alpine reactivity.
          // Do NOT call another getter (like 'filtered') - Alpine won't track those dependencies.
          const filtered = this.items.filter(entry => {
            if (this.filterList && entry.listName !== this.filterList) return false;
            if (this.filterPrize && entry.prize !== this.filterPrize) return false;
            if (this.filterDate) {
              const entryDate = new Date(entry.timestamp).toISOString().split('T')[0];
              if (entryDate !== this.filterDate) return false;
            }
            return true;
          });

          // Then sort
          return filtered.sort((a, b) => {
            let valA, valB;
            switch (this.sortField) {
              case 'date': valA = a.timestamp || 0; valB = b.timestamp || 0; break;
              case 'list': valA = a.listName?.toLowerCase() || ''; valB = b.listName?.toLowerCase() || ''; break;
              case 'prize': valA = a.prize?.toLowerCase() || ''; valB = b.prize?.toLowerCase() || ''; break;
              case 'count': valA = a.winners?.length || 0; valB = b.winners?.length || 0; break;
              default: valA = a.timestamp || 0; valB = b.timestamp || 0;
            }
            if (valA < valB) return this.sortDir === 'asc' ? -1 : 1;
            if (valA > valB) return this.sortDir === 'asc' ? 1 : -1;
            return 0;
          });
        },

        get uniqueLists() {
          const lists = new Set();
          this.items.forEach(entry => {
            if (entry.listName) lists.add(entry.listName);
          });
          return Array.from(lists).sort();
        },

        get uniquePrizes() {
          const prizes = new Set();
          this.items.forEach(entry => {
            if (entry.prize) prizes.add(entry.prize);
          });
          return Array.from(prizes).sort();
        },

        get stats() {
          const totalSelections = this.items.length;
          const prizeCount = {};
          this.items.forEach(entry => {
            prizeCount[entry.prize] = (prizeCount[entry.prize] || 0) + 1;
          });
          const mostUsedPrize = Object.keys(prizeCount).reduce((a, b) =>
            prizeCount[a] > prizeCount[b] ? a : b, '-'
          );
          return { totalSelections, mostUsedPrize };
        },

        clearFilters() {
          this.filterList = '';
          this.filterPrize = '';
          this.filterDate = '';
        }
      });

      // UI state store
      Alpine.store('ui', {
        view: Alpine.$persist('public').as('ui_view'), // 'public' or 'management'
        currentTab: Alpine.$persist('quicksetup').as('ui_currentTab'),

        // Progress overlay state
        showProgress: false,
        progressTitle: 'Processing...',
        progressText: 'Please wait...',
        progressPercent: 0,

        init() {
          // Restore saved tab when returning to management view
          const restoreTab = () => {
            if (this.view === 'management' && this.currentTab) {
              const tabTrigger = document.querySelector(`[data-bs-target="#${this.currentTab}"]`);
              if (tabTrigger && window.bootstrap) {
                const tab = new bootstrap.Tab(tabTrigger);
                tab.show();
              }
            }
          };

          // Wait for DOM to be ready for tab restoration
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', restoreTab);
          } else {
            setTimeout(restoreTab, 150);
          }
        },

        showManagement() {
          this.view = 'management';
        },

        showPublic() {
          this.view = 'public';
          this.currentTab = 'quicksetup';
        },

        setTab(tabId) {
          this.currentTab = tabId;
        },

        // Progress overlay methods
        startProgress(title, text) {
          this.progressTitle = title || 'Processing...';
          this.progressText = text || 'Please wait...';
          this.progressPercent = 0;
          this.showProgress = true;
        },

        updateProgressState(percent, text) {
          this.progressPercent = percent;
          if (text) this.progressText = text;
        },

        endProgress() {
          this.showProgress = false;
        },

        // Trigger modal button click (cleaner than inline getElementById)
        openModal(buttonId) {
          document.getElementById(buttonId)?.click();
        }
      });

      // Reusable component: Confirmation Modal (pure Alpine - no legacy DOM hacks)
      Alpine.data('confirmModal', () => ({
        title: '',
        message: '',
        customContent: '',
        confirmText: 'Confirm',
        confirmClass: 'btn-danger',
        onConfirm: null,
        bsModal: null,

        init() {
          this.bsModal = bootstrap.Modal.getOrCreateInstance(this.$el);
          // Make accessible for UI.showConfirmationModal bridge
          window.alpineConfirmModal = this;
          // Legacy alias (confirmModal is now the primary modal for confirmations)
          window.appModal = this.bsModal;

          // Blur focused element before hiding to prevent aria-hidden warning
          this.$el.addEventListener('hide.bs.modal', () => {
            document.activeElement?.blur();
            // Workaround for Bootstrap bug: clear data-bs-overflow before hiding
            document.body.removeAttribute('data-bs-overflow');
          });

          // Reset Alpine state when modal is hidden
          this.$el.addEventListener('hidden.bs.modal', () => {
            this.reset();
          });
        },

        show(options) {
          this.title = options.title || '';
          this.message = options.message || '';
          this.customContent = options.customContent || '';
          this.confirmText = options.confirmText || 'Confirm';
          this.confirmClass = options.confirmClass || 'btn-danger';
          this.onConfirm = options.onConfirm || null;
          this.bsModal.show();
        },

        confirm() {
          if (this.onConfirm) this.onConfirm();
          // Workaround for Bootstrap bug: clear data-bs-overflow before hiding
          document.body.removeAttribute('data-bs-overflow');
          this.bsModal.hide();
        },

        close() {
          document.body.removeAttribute('data-bs-overflow');
          this.bsModal.hide();
        },

        reset() {
          this.title = '';
          this.message = '';
          this.customContent = '';
          this.confirmText = 'Confirm';
          this.confirmClass = 'btn-danger';
          this.onConfirm = null;
        }
      }));

      // Reusable component: View Modal (pure Alpine - for read-only displays)
      Alpine.data('viewModal', () => ({
        title: '',
        contentType: '', // 'list', 'smsResults', 'qrCode', 'custom'
        hideEntryCounts: false,
        listData: {
          listId: null,
          entries: [],
          displayColumns: [],
          entryCount: 0,
          skippedWinners: 0,
          nameConfig: null
        },
        smsData: {
          successRate: 0,
          successCount: 0,
          failedCount: 0,
          failed: [],
          alertClass: 'alert-info'
        },
        qrData: {
          ticketCode: '',
          qrCodeUrl: ''
        },
        customHtml: '',
        bsModal: null,

        init() {
          this.bsModal = bootstrap.Modal.getOrCreateInstance(this.$el);
          window.alpineViewModal = this;
          window.viewModal = this.bsModal;

          this.$el.addEventListener('hide.bs.modal', () => {
            document.activeElement?.blur();
            // Workaround for Bootstrap bug: clear data-bs-overflow before hiding
            document.body.removeAttribute('data-bs-overflow');
          });

          this.$el.addEventListener('hidden.bs.modal', () => {
            this.reset();
          });
        },

        // Show list entries
        async showList(list) {
          this.title = `List: ${list.metadata.name}`;
          this.contentType = 'list';
          this.hideEntryCounts = window.settings?.hideEntryCounts || false;

          // Get display columns from sample entries
          const sampleEntries = list.entries.slice(0, 10);
          const allColumns = new Set();
          sampleEntries.forEach(entry => {
            if (entry.data) {
              Object.keys(entry.data).forEach(col => allColumns.add(col));
            }
          });
          const columns = Array.from(allColumns).sort().slice(0, 5);

          // Format entries with display names
          const formattedEntries = list.entries.map(entry => ({
            id: entry.id,
            displayName: Lists.formatDisplayName(entry, list.metadata.nameConfig),
            data: entry.data
          }));

          this.listData = {
            listId: list.listId,
            entries: formattedEntries,
            displayColumns: columns,
            entryCount: list.entries.length,
            skippedWinners: list.metadata.skippedWinners || 0,
            nameConfig: list.metadata.nameConfig
          };

          this.bsModal.show();
        },

        // Delete entry from list view
        async deleteEntry(entryId) {
          await Lists.deleteListEntry(this.listData.listId, entryId);
        },

        // Refresh list after entry deletion
        async refreshList() {
          if (this.listData.listId) {
            const list = await Database.getFromStore('lists', this.listData.listId);
            if (list) {
              await this.showList(list);
            }
          }
        },

        // Show SMS send results
        showSmsResults(results) {
          this.title = 'SMS Send Results';
          this.contentType = 'smsResults';

          const successRate = Math.round((results.successful.length / results.total) * 100);
          const alertClass = successRate === 100 ? 'alert-success' : successRate > 50 ? 'alert-warning' : 'alert-danger';

          this.smsData = {
            successRate,
            successCount: results.successful.length,
            failedCount: results.failed.length,
            failed: results.failed,
            alertClass
          };

          this.bsModal.show();
        },

        // Show QR code for winner
        showQRCode(ticketCode) {
          this.title = 'Winner Ticket QR Code';
          this.contentType = 'qrCode';

          this.qrData = {
            ticketCode,
            qrCodeUrl: `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(ticketCode)}`
          };

          this.bsModal.show();
        },

        // Show custom HTML content
        showCustom(title, html) {
          this.title = title;
          this.contentType = 'custom';
          this.customHtml = html;
          this.bsModal.show();
        },

        close() {
          document.body.removeAttribute('data-bs-overflow');
          this.bsModal.hide();
        },

        reset() {
          this.title = '';
          this.contentType = '';
          this.listData = { listId: null, entries: [], displayColumns: [], entryCount: 0, skippedWinners: 0, nameConfig: null };
          this.smsData = { successRate: 0, successCount: 0, failedCount: 0, failed: [], alertClass: 'alert-info' };
          this.qrData = { ticketCode: '', qrCodeUrl: '' };
          this.customHtml = '';
        }
      }));

      // Reusable component: Form Modal (pure Alpine - for Add/Edit operations)
      Alpine.data('formModal', () => ({
        title: '',
        formType: '', // 'prize' or 'template'
        formData: {},
        templates: [], // For prize form's template dropdown
        placeholders: [], // For template form's placeholder list
        isEditing: false,
        editingId: null,
        bsModal: null,

        init() {
          this.bsModal = bootstrap.Modal.getOrCreateInstance(this.$el);
          window.alpineFormModal = this;
          window.formModal = this.bsModal;

          // Blur focused element before hiding to prevent aria-hidden warning
          this.$el.addEventListener('hide.bs.modal', () => {
            document.activeElement?.blur();
            // Workaround for Bootstrap bug: clear data-bs-overflow before hiding
            document.body.removeAttribute('data-bs-overflow');
          });

          this.$el.addEventListener('hidden.bs.modal', () => {
            this.reset();
          });
        },

        get saveButtonText() {
          if (this.formType === 'prize') {
            return this.isEditing ? 'Save Changes' : 'Add Prize';
          } else if (this.formType === 'template') {
            return this.isEditing ? 'Save Changes' : 'Save Template';
          }
          return 'Save';
        },

        // Open prize form
        async openPrizeForm(prize = null) {
          this.formType = 'prize';
          this.isEditing = !!prize;
          this.editingId = prize?.prizeId || null;
          this.title = prize ? 'Edit Prize' : 'Add New Prize';

          // Load templates for dropdown
          this.templates = await Database.getFromStore('templates') || [];

          // Set form data
          this.formData = {
            name: prize?.name || '',
            quantity: prize?.quantity ?? 1,
            winnersCount: prize?.winnersCount || 1,
            description: prize?.description || '',
            templateId: prize?.templateId || ''
          };

          this.bsModal.show();
        },

        // Open template form
        async openTemplateForm(template = null) {
          this.formType = 'template';
          this.isEditing = !!template;
          this.editingId = template?.templateId || null;
          this.title = template ? 'Edit SMS Template' : 'Add SMS Template';

          // Load placeholders
          this.placeholders = await this.getAvailablePlaceholders();

          // Set form data
          this.formData = {
            name: template?.name || '',
            message: template?.message || '',
            isDefault: template?.isDefault || false
          };

          this.bsModal.show();
        },

        async getAvailablePlaceholders() {
          const fieldSet = new Set(['name', 'prize', 'ticketCode', 'eventName']);
          try {
            const lists = await Database.getFromStore('lists');
            const settingsData = Settings.data;

            const selectedLists = settingsData?.selectedListIds?.length > 0
              ? lists.filter(list => settingsData.selectedListIds.includes(list.listId))
              : lists;

            selectedLists.forEach(list => {
              if (list.entries?.[0]?.data) {
                Object.keys(list.entries[0].data).forEach(key => fieldSet.add(key));
              }
            });
          } catch (e) {
            console.error('Error loading placeholders:', e);
          }
          return Array.from(fieldSet).sort();
        },

        async save() {
          if (this.formType === 'prize') {
            await this.savePrize();
          } else if (this.formType === 'template') {
            await this.saveTemplate();
          }
        },

        async savePrize() {
          const { name, quantity, winnersCount, description, templateId } = this.formData;

          if (!name?.trim()) {
            UI.showToast('Please enter a prize name', 'warning');
            return;
          }

          if (quantity < 0) {
            UI.showToast('Please enter a valid quantity', 'warning');
            return;
          }

          if (winnersCount < 1 || winnersCount > 100) {
            UI.showToast('Winners count must be between 1 and 100', 'warning');
            return;
          }

          try {
            const prize = {
              prizeId: this.editingId || UI.generateId(),
              name: name.trim(),
              quantity: quantity,
              winnersCount: winnersCount,
              description: description?.trim() || '',
              templateId: templateId || null,
              timestamp: Date.now()
            };

            await Database.saveToStore('prizes', prize);
            UI.showToast(this.isEditing ? 'Prize updated' : `Prize "${name}" added`, 'success');

            await Prizes.loadPrizes(); // Alpine store updates reactively
            document.body.removeAttribute('data-bs-overflow');
            this.bsModal.hide();
          } catch (error) {
            console.error('Error saving prize:', error);
            UI.showToast('Error saving prize: ' + error.message, 'error');
          }
        },

        async saveTemplate() {
          const { name, message, isDefault } = this.formData;

          if (!name?.trim() || !message?.trim()) {
            UI.showToast('Please fill in all fields', 'warning');
            return;
          }

          try {
            // If setting as default, unset other defaults
            if (isDefault) {
              const templates = await Database.getFromStore('templates');
              for (const tmpl of templates) {
                if (tmpl.templateId !== this.editingId && tmpl.isDefault) {
                  tmpl.isDefault = false;
                  await Database.saveToStore('templates', tmpl);
                }
              }
            }

            const template = {
              templateId: this.editingId || `tmpl_${Date.now()}`,
              name: name.trim(),
              message: message.trim(),
              isDefault: isDefault,
              ...(this.isEditing ? { updatedAt: new Date().toISOString() } : { createdAt: new Date().toISOString() })
            };

            await Database.saveToStore('templates', template);
            await Templates.loadTemplates();
            UI.showToast(this.isEditing ? 'Template updated' : 'Template added', 'success');
            document.body.removeAttribute('data-bs-overflow');
            this.bsModal.hide();
          } catch (error) {
            console.error('Error saving template:', error);
            UI.showToast('Failed to save template', 'error');
          }
        },

        reset() {
          this.title = '';
          this.formType = '';
          this.formData = {};
          this.templates = [];
          this.placeholders = [];
          this.isEditing = false;
          this.editingId = null;
        }
      }));

      // Reusable component: Winner Helpers (SMS status, order ID formatting)
      Alpine.data('winnerHelpers', () => ({
        getSmsStatus(winner) {
          if (!winner.sms || !winner.sms.status) {
            return { class: 'badge bg-secondary', icon: 'bi-dash-circle', text: 'Not Sent' };
          }
          const statusMap = {
            'delivered': { class: 'badge bg-success', icon: 'bi-check-circle-fill', text: 'Delivered' },
            'bounced': { class: 'badge bg-danger', icon: 'bi-x-circle-fill', text: 'Bounced' },
            'failed': { class: 'badge bg-danger', icon: 'bi-x-circle-fill', text: 'Failed' },
            'queued': { class: 'badge bg-info', icon: 'bi-clock-fill', text: 'Queued' },
            'sending': { class: 'badge bg-warning', icon: 'bi-arrow-up-circle-fill', text: 'Sending' },
            'sent': { class: 'badge bg-primary', icon: 'bi-send-fill', text: 'Sent' }
          };
          return statusMap[winner.sms.status.toLowerCase()] || { class: 'badge bg-secondary', icon: 'bi-dash-circle', text: 'Not Sent' };
        },

        getOrderId(winner) {
          return winner.orderId || winner.orderCode || winner.entryId || winner.data?.idCard || winner.data?.contactId || 'N/A';
        }
      }));
    });
  </script>

  <!-- Alpine.js Core (loads after inline setup, triggers alpine:init) -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.15.2/dist/cdn.min.js"></script>

  <!-- Vite Entry Point -->
  <script type="module" src="./src/main.js"></script>
</body>
</html>