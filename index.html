<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>River Winner</title>
  <!-- Meta Tags -->
  <meta name="theme-color" content="#6366f1">
  <meta name="description" content="Professional random winner selection application">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <!-- Bootstrap CSS for modern styling -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@300;400;600;700&family=Lato:wght@300;400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Toastify for notifications -->
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/src/css/styles.css">
</head>
<body data-theme="light" x-data>
  <!-- Main Public Selection Interface -->
  <div class="public-selection-interface" id="publicInterface">
    <!-- Header -->
    <div class="selection-header">
      <div class="d-flex align-items-center">
        <img src="/favicon.png" width="40" class="me-2">
        <h4 class="mb-0"></h4>
      </div>
      <!-- Prize Display in Header (Hidden initially) -->
      <div class="prize-display-header d-none" id="prizeDisplay">
        <div class="prize-name-header" id="displayPrizeName"></div>
        <div class="prize-subtitle-header" id="displayPrizeSubtitle"></div>
      </div>
      <div class="d-flex gap-2">
        <!-- Winner Action Buttons (Hidden initially) -->
        <button class="btn btn-outline-light d-none" id="newSelectionBtn" title="Start new selection">
          <i class="bi bi-arrow-repeat"></i>
        </button>
        <button class="btn btn-outline-warning d-none" id="undoSelectionBtn" title="Undo last selection">
          <i class="bi bi-arrow-counterclockwise"></i>
        </button>
        <!-- SMS Button (Hidden initially) -->
        <button class="btn btn-outline-success d-none" id="sendSMSBtn" title="Send SMS to current winners">
          <i class="bi bi-envelope-fill"></i></button>
        <button class="btn btn-outline-light" id="fullscreenToggle" title="Toggle fullscreen">
          <i class="bi bi-fullscreen"></i>
        </button>
        <button class="btn btn-outline-light" id="managementToggle" x-on:click="$store.ui.showManagement()">
          <i class="bi bi-list-ul"></i> Manage
        </button>
      </div>
    </div>
    <!-- Main Selection Area -->
    <div class="selection-main">
      <!-- Selection Controls -->
      <div class="selection-controls" id="selectionControls">
        <h1 class="selection-title">Winner Selection</h1>
        <p class="selection-subtitle">Get ready for the big moment!</p>
        <!-- Selection Info -->
        <div class="selection-info">
          <div class="info-card">
            <div class="info-label">Current List</div>
            <div class="info-value" id="currentListDisplay" x-text="$store.setup.listDisplayText">Not Selected</div>
          </div>
          <div class="info-card" id="totalEntriesCard" x-show="!$store.settings.hideEntryCounts">
            <div class="info-label">Total Entries</div>
            <div class="info-value" id="totalEntriesDisplay" x-text="$store.setup.totalEntries">0</div>
          </div>
          <div class="info-card">
            <div class="info-label">Winners to Select</div>
            <div class="info-value" id="winnersCountDisplay" x-text="$store.setup.winnersCount">1</div>
          </div>
          <div class="info-card">
            <div class="info-label">Prize</div>
            <div class="info-value" id="currentPrizeDisplay" x-text="$store.setup.prizeDisplayText">Not Selected</div>
          </div>
        </div>
        <!-- Big Play Button -->
        <button class="big-play-button" id="bigPlayButton" :disabled="!$store.setup.canStart">
          <i class="bi bi-play-fill"></i>
        </button>
      </div>
      <!-- Winners Grid Display -->
      <div class="winners-grid d-none" id="winnersGrid">
        <!-- Winner cards will be inserted here dynamically -->
      </div>
    </div>
  </div>
  <!-- Management (Hidden by default) -->
  <div class="container-fluid management-tabs" id="managementInterface">
    <div class="row">
      <div class="col-12">
        <!-- Header for management -->
        <div class="d-flex justify-content-between align-items-center py-3 border-bottom">
          <h3><i class="bi bi-gear me-2"></i>Management</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-light" id="themeToggle" title="Toggle theme">
              <i class="bi bi-moon-fill"></i>
            </button>
            <div class="dropdown">
              <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i>
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="./scan.html" target="_blank"><i class="bi bi-qr-code-scan me-2"></i>Prize Pickup Scanner</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="undoLastSelection"><i class="bi bi-arrow-counterclockwise me-2"></i>Undo Last Selection</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="backupData"><i class="bi bi-download me-2"></i>Backup Local</a></li>
                <li><a class="dropdown-item" href="#" id="restoreData"><i class="bi bi-upload me-2"></i>Restore Local</a></li>
                <li>
                  <hr class="dropdown-divider">
                </li>
                <li><a class="dropdown-item" href="#" id="backupOnline"><i class="bi bi-cloud-upload me-2"></i>Backup Online</a></li>
                <li><a class="dropdown-item" href="#" id="restoreOnline"><i class="bi bi-cloud-download me-2"></i>Restore Online</a></li>
              </ul>
            </div>
            <button class="btn btn-primary" id="backToPublicBtn" x-on:click="$store.ui.showPublic()">
              <i class="bi bi-eye me-2"></i>Public View
            </button>
          </div>
        </div>
        <!-- Management Tabs -->
        <ul class="nav nav-tabs mt-3" id="managementTabs" role="tablist"
            x-init="$el.addEventListener('shown.bs.tab', (e) => $store.ui.setTab(e.target.getAttribute('data-bs-target').replace('#', '')))">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="quicksetup-tab" data-bs-toggle="tab" data-bs-target="#quicksetup" type="button" role="tab">
              <i class="bi bi-play-circle me-2"></i>Setup
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="lists-tab" data-bs-toggle="tab" data-bs-target="#lists" type="button" role="tab">
              <i class="bi bi-list-ul me-2"></i>Lists
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="prizes-tab" data-bs-toggle="tab" data-bs-target="#prizes" type="button" role="tab">
              <i class="bi bi-gift me-2"></i>Prizes
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
              <i class="bi bi-chat-text me-2"></i>Templates
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="winners-tab" data-bs-toggle="tab" data-bs-target="#winners" type="button" role="tab">
              <i class="bi bi-trophy me-2"></i>Winners
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">
              <i class="bi bi-clock-history me-2"></i>History
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
              <i class="bi bi-sliders me-2"></i>Settings
            </button>
          </li>
        </ul>
        <!-- Tab Content -->
        <div class="tab-content mt-3" id="managementTabContent">
          <!-- Setup Tab -->
          <div class="tab-pane fade show active" id="quicksetup" role="tabpanel" x-data>
            <!-- Row 1: Full Width Quick Selection Setup -->
            <div class="card">
              <div class="card-header">
                <h5 class="card-title"><i class="bi bi-gear-fill me-2"></i>Quick Selection Setup</h5>
              </div>
              <div class="card-body">
                <p class="card-text text-muted mb-4">Configure the next public winner selection from here.</p>
                <!-- Main Selection Controls in a Row -->
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label fw-semibold">Select Lists</label>
                    <div class="list-selection-container">
                      <div class="list-selection-controls mb-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllLists">Select All</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllLists">Clear All</button>
                        <span class="ms-2 text-muted" x-text="$store.setup.selectedListIds.length + ' lists selected'"></span>
                      </div>
                      <div class="list-checkboxes border rounded p-2" id="quickListSelect" style="max-height: 200px; overflow-y: auto;">
                        <template x-for="list in $store.lists.items" :key="list.listId">
                          <div class="form-check">
                            <input class="form-check-input list-checkbox" type="checkbox"
                                   :id="'list-' + list.listId"
                                   :value="list.listId"
                                   :checked="$store.setup.selectedListIds.includes(list.listId)"
                                   @change="$store.setup.toggleList(list.listId)">
                            <label class="form-check-label" :for="'list-' + list.listId">
                              <span x-text="list.metadata.name"></span>
                              <span class="text-muted" x-text="'(' + list.entries.length + ')'"></span>
                            </label>
                          </div>
                        </template>
                        <p x-show="$store.lists.items.length === 0" class="text-muted mb-0">No lists uploaded yet</p>
                      </div>
                      <div class="mt-2">
                        <small class="text-muted">Total entries: <span x-text="$store.setup.totalEntries">0</span></small>
                        <small class="text-muted ms-2" id="duplicatesRemoved"></small>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-5">
                    <label class="form-label fw-semibold">Select Prize</label>
                    <select class="form-select form-select-lg" id="quickPrizeSelect"
                            x-model="$store.setup.selectedPrizeId">
                      <option value="">Select Prize...</option>
                      <template x-for="prize in $store.prizes.items" :key="prize.prizeId">
                        <option :value="prize.prizeId" x-text="prize.name + ' (' + prize.quantity + ' available)'"></option>
                      </template>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label fw-semibold">Number of Winners</label>
                    <input type="number" class="form-control form-control-lg" id="quickWinnersCount" value="1" min="1" max="9999" placeholder="Count"
                           x-model.number="$store.setup.winnersCount">
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Row 2: Reveal Settings | Delay Settings -->
            <div class="row g-4 mt-3">
              <!-- Reveal Settings Card (Left Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-eye-fill me-2"></i>Reveal Settings
                      <i class="bi bi-info-circle text-muted ms-1" title="Configure how winners are revealed"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Selection Mode
                        <i class="bi bi-info-circle text-muted ms-1" title="How winners are selected and revealed"></i>
                      </label>
                      <select class="form-select form-select-lg" id="selectionMode"
                              x-model="$store.settings.selectionMode"
                              @change="$store.settings.save('selectionMode')">
                        <option value="all-at-once">All at Once</option>
                        <option value="sequential">Sequential Reveal</option>
                        <option value="individual">Individual Selection</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Display Effect
                        <i class="bi bi-info-circle text-muted ms-1" title="How winners appear on screen"></i>
                      </label>
                      <select class="form-select form-select-lg" id="displayEffect"
                              x-model="$store.settings.displayEffect"
                              @change="$store.settings.save('displayEffect')">
                        <option value="fade-in">Fade In</option>
                        <option value="fly-in">Fly In</option>
                        <option value="zoom-in">Zoom In</option>
                        <option value="slide-in">Slide In</option>
                        <option value="bounce-in">Bounce In</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Time Between Winners (seconds)
                        <i class="bi bi-info-circle text-muted ms-1" title="Delay between each winner being revealed (sequential mode only)"></i>
                      </label>
                      <input type="number" class="form-control form-control-lg" id="displayDuration" value="0.5" min="0.1" max="5" step="0.1"
                             x-model.number="$store.settings.displayDuration"
                             @change="$store.settings.save('displayDuration')">
                    </div>
                  </div>
                </div>
              </div>
              <!-- Delay Settings Card (Right Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-clock-fill me-2"></i>Delay Settings
                      <i class="bi bi-info-circle text-muted ms-1" title="Configure pre-selection delay options"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Delay Duration (seconds)
                        <i class="bi bi-info-circle text-muted ms-1" title="Delay before selection begins"></i>
                      </label>
                      <input type="number" class="form-control form-control-lg" id="preSelectionDelay" value="0" min="0" max="30" step="0.5"
                             x-model.number="$store.settings.preSelectionDelay"
                             @change="$store.settings.save('preSelectionDelay')">
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Delay Visual
                        <i class="bi bi-info-circle text-muted ms-1" title="What to show during the delay"></i>
                      </label>
                      <select class="form-select form-select-lg" id="delayVisualType"
                              x-model="$store.settings.delayVisualType"
                              @change="$store.settings.save('delayVisualType')">
                        <option value="none">No Visual (Silent)</option>
                        <option value="countdown">Countdown Timer</option>
                        <option value="animation">Particle Animation</option>
                        <option value="swirl-animation">Swirl Animation</option>
                        <option value="time-machine">Time Machine</option>
                      </select>
                    </div>
                    <div>
                      <button type="button" class="btn btn-outline-info" id="previewDelayBtn">
                        <i class="bi bi-eye me-1"></i>Preview Delay
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Row 3: Celebration Effects | Sound Settings -->
            <div class="row g-4 mt-3">
              <!-- Celebration Effects Card (Left Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-star-fill me-2"></i>Celebration Effects
                      <i class="bi bi-info-circle text-muted ms-1" title="Visual effects when winners are revealed"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label for="celebrationEffect" class="form-label fw-semibold">Celebration Animation</label>
                      <select class="form-select form-select-lg" id="celebrationEffect"
                              x-model="$store.settings.celebrationEffect"
                              @change="$store.settings.save('celebrationEffect')">
                        <option value="none">No Animation</option>
                        <option value="confetti">Confetti</option>
                        <option value="coins">Gold Coins</option>
                        <option value="both">Both Confetti & Coins</option>
                      </select>
                    </div>
                    <div class="mb-3">
                      <label for="celebrationDuration" class="form-label fw-semibold">Animation Duration (seconds)</label>
                      <input type="number" class="form-control form-control-lg" id="celebrationDuration" min="1" max="10" step="0.5" value="4"
                             x-model.number="$store.settings.celebrationDuration"
                             @change="$store.settings.save('celebrationDuration')">
                    </div>
                    <div class="mb-3">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="celebrationAutoTrigger"
                               x-model="$store.settings.celebrationAutoTrigger"
                               @change="$store.settings.save('celebrationAutoTrigger')">
                        <label class="form-check-label" for="celebrationAutoTrigger">
                          Auto-trigger celebration when winners are revealed
                        </label>
                      </div>
                    </div>
                    <div>
                      <button type="button" class="btn btn-sm btn-outline-secondary" id="testCelebrationEffect">
                        <i class="bi bi-play-fill me-1"></i>Test Celebration
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Sound Settings Card (Right Column) -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header">
                    <h5 class="card-title">
                      <i class="bi bi-volume-up-fill me-2"></i>Sound Settings
                      <i class="bi bi-info-circle text-muted ms-1" title="Configure sound effects for the selection process"></i>
                    </h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Sound During Delay
                        <i class="bi bi-info-circle text-muted ms-1" title="Sound effect played during pre-selection delay"></i>
                      </label>
                      <div class="input-group">
                        <select class="form-select form-select-lg" id="soundDuringDelay"
                                x-model="$store.settings.soundDuringDelay"
                                @change="$store.settings.save('soundDuringDelay')">
                          <option value="none">No Sound</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="testSoundDuringDelay">
                          <i class="bi bi-play-fill"></i> Test
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Sound at End of Delay
                        <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Sound effect when delay completes"></i>
                      </label>
                      <div class="input-group">
                        <select class="form-select form-select-lg" id="soundEndOfDelay"
                                x-model="$store.settings.soundEndOfDelay"
                                @change="$store.settings.save('soundEndOfDelay')">
                          <option value="none">No Sound</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="testSoundEndOfDelay">
                          <i class="bi bi-play-fill"></i> Test
                        </button>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label fw-semibold">
                        Sound During Reveal
                        <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Sound effect when winners are revealed"></i>
                      </label>
                      <div class="input-group">
                        <select class="form-select form-select-lg" id="soundDuringReveal"
                                x-model="$store.settings.soundDuringReveal"
                                @change="$store.settings.save('soundDuringReveal')">
                          <option value="none">No Sound</option>
                        </select>
                        <button type="button" class="btn btn-outline-secondary" id="testSoundDuringReveal">
                          <i class="bi bi-play-fill"></i> Test
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Lists Tab -->
      <div class="tab-pane fade" id="lists" role="tabpanel" x-data>
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title mb-0">List Management</h5>
              <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-plus-circle me-2"></i>Add
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="#" id="uploadListModalBtn">
                      <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV File
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" id="addFromReportBtn">
                      <i class="bi bi-ticket-perforated me-2"></i>Pretix Report
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" id="addFromMPBtn">
                      <i class="bi bi-database me-2"></i>Ministry Platform
                    </a>
                  </li>
                </ul>
              </div>
            </div>

            <!-- Multi-select controls -->
            <div class="alert alert-info mb-3" x-show="$store.lists.items.length > 0">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <i class="bi bi-info-circle me-2"></i>
                  <span>Select multiple lists to use for giveaways</span>
                </div>
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-primary" id="selectAllListsTab">
                    <i class="bi bi-check-square me-1"></i>Select All
                  </button>
                  <button type="button" class="btn btn-outline-secondary" id="clearAllListsTab">
                    <i class="bi bi-square me-1"></i>Clear All
                  </button>
                </div>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  <span x-text="$store.setup.selectedListIds.length + ' lists selected'">0 lists selected</span> |
                  <span x-text="$store.setup.totalEntries + ' total entries'">0 total entries</span>
                </small>
              </div>
            </div>

            <!-- Lists Grid -->
            <div class="row g-4" id="listsGrid">
              <template x-for="list in $store.lists.items" :key="list.listId">
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 list-card-selectable"
                       :class="{ 'border-success': $store.setup.selectedListIds.includes(list.listId) }"
                       @click="$store.setup.toggleList(list.listId)"
                       style="cursor: pointer;">
                    <div class="card-header">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-truncate" x-text="list.metadata.name" style="max-width: 180px;"></h6>
                        <div>
                          <span class="badge bg-success me-1" x-show="$store.setup.selectedListIds.includes(list.listId)">
                            <i class="bi bi-check-circle-fill"></i>
                          </span>
                          <span class="badge bg-secondary" x-text="list.entries.length"></span>
                        </div>
                      </div>
                    </div>
                    <div class="card-body d-flex flex-column">
                      <p class="card-text text-muted small mb-2">
                        Uploaded <span x-text="new Date(list.metadata.timestamp).toLocaleDateString()"></span>
                      </p>
                      <div class="mt-auto pt-2">
                        <div class="d-flex justify-content-between align-items-center">
                          <button class="btn btn-sm"
                                  :class="$store.setup.selectedListIds.includes(list.listId) ? 'btn-success' : 'btn-outline-success'"
                                  @click.stop="$store.setup.toggleList(list.listId)">
                            <i :class="$store.setup.selectedListIds.includes(list.listId) ? 'bi bi-check-circle-fill' : 'bi bi-check-circle'"></i>
                            <span x-text="$store.setup.selectedListIds.includes(list.listId) ? 'Selected' : 'Select'"></span>
                          </button>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" @click.stop="Lists.viewList(list.listId)" title="View entries">
                              <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-outline-danger" @click.stop="Lists.deleteListConfirm(list.listId)" title="Delete list">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <!-- Empty state -->
            <div id="noListsMessage" class="text-center py-5" x-show="$store.lists.items.length === 0">
              <i class="bi bi-file-earmark-spreadsheet display-1 text-muted"></i>
              <p class="text-muted mt-3">No lists uploaded yet</p>
              <div class="dropdown d-inline-block">
                <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  <i class="bi bi-plus-circle me-2"></i>Add
                </button>
                <ul class="dropdown-menu">
                  <li>
                    <a class="dropdown-item" href="#" onclick="document.getElementById('uploadListModalBtn').click(); return false;">
                      <i class="bi bi-file-earmark-spreadsheet me-2"></i>CSV File
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" onclick="document.getElementById('addFromReportBtn').click(); return false;">
                      <i class="bi bi-ticket-perforated me-2"></i>Pretix Report
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="#" onclick="document.getElementById('addFromMPBtn').click(); return false;">
                      <i class="bi bi-database me-2"></i>Ministry Platform
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <!-- Hidden input for CSV upload -->
            <input type="file" id="csvFile" accept=".csv" style="display: none;">
          </div>
        </div>
        <!-- Configuration Card - Full Width -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card" id="nameConfigCard" style="display: none;">
              <div class="card-body">
                <div class="mb-3">
                  <label for="listName" class="form-label">List Name (Optional)</label>
                  <input type="text" class="form-control" id="listName" placeholder="Enter custom list name or leave empty to use filename">
                  <div class="form-text">If left empty, the CSV filename will be used as the list name.</div>
                </div>
                <hr>
                <div class="row">
                  <div class="col-12 col-lg-6">
                    <h5 class="card-subtitle mb-3 text-muted">Record ID Configuration</h5>
                    <div class="mb-3">
                      <label class="form-label">Record ID Source</label>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="idSource" id="autoGenerateId" value="auto">
                        <label class="form-check-label" for="autoGenerateId">
                          Auto-generate unique IDs
                        </label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="idSource" id="useColumnId" value="column" checked>
                        <label class="form-check-label" for="useColumnId">
                          Use column as record ID
                        </label>
                      </div>
                    </div>
                    <div class="mb-3" id="columnIdSection" style="display: none;">
                      <label for="idColumnSelect" class="form-label">Select ID Column</label>
                      <select class="form-select" id="idColumnSelect">
                        <option value="">Select a column...</option>
                      </select>
                      <div class="form-text">Selected column values must be unique for each record.</div>
                    </div>
                    <div class="mb-3 border rounded p-3 bg-light">
                      <label class="form-label fw-bold">Upload Options</label>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="skipExistingWinners">
                        <label class="form-check-label" for="skipExistingWinners">
                          <strong>Skip records that are already in the winner list</strong>
                          <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="When enabled, records are matched by their unique ID only. Records with the same name but different IDs will still be uploaded."></i>
                        </label>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-lg-6">
                    <h5 class="card-title mb-3">Name Display Configuration</h5>
                    <p class="text-muted small">Click on the fields below to build your name template.</p>
                    <div class="mb-3">
                      <label for="nameTemplate" class="form-label">Name Template</label>
                      <input type="text" class="form-control" id="nameTemplate" placeholder="{LastName}, {FirstName}">
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Available Fields</label>
                      <div id="availableFields" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Preview</label>
                      <div class="p-2 bg-light border rounded" id="namePreview"></div>
                    </div>
                  </div>
                </div>
                <!-- Info Field Configuration -->
                <div class="row mt-4">
                  <div class="col-12">
                    <h5 class="card-title mb-3">Winner Card Display Configuration</h5>
                    <p class="text-muted small">Configure what information appears on winner cards. Each field can use multiple columns.</p>
                    <div class="row">
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label for="info1Template" class="form-label">Info 1 (Primary - Bold, Large)</label>
                          <input type="text" class="form-control" id="info1Template" placeholder="{FirstName} {LastName}">
                          <div class="form-text">Main identifier (e.g., full name)</div>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label for="info2Template" class="form-label">Info 2 (Secondary - Medium)</label>
                          <input type="text" class="form-control" id="info2Template" placeholder="{Department}">
                          <div class="form-text">Secondary info (e.g., department, title)</div>
                        </div>
                      </div>
                      <div class="col-lg-4">
                        <div class="mb-3">
                          <label for="info3Template" class="form-label">Info 3 (Tertiary - Small)</label>
                          <input type="text" class="form-control" id="info3Template" placeholder="{Email}">
                          <div class="form-text">Additional info (e.g., email, phone)</div>
                        </div>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Available Fields for Info Templates</label>
                      <div id="infoAvailableFields" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Winner Card Preview</label>
                      <div class="p-3 bg-light border rounded" style="min-height: 150px; display: flex; align-items: center; justify-content: center;">
                        <div class="winner-card-preview" style="position: relative; background: rgba(255, 255, 255, 0.95); border-radius: 12px; padding: 1.5rem; box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25), 0 5px 15px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); color: #333; text-align: center; min-width: 200px; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                          <div class="winner-number-preview" style="position: absolute; top: -15px; left: -15px; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color, #007bff), var(--secondary-color, #0056b3)); color: white; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; z-index: 10;">1</div>
                          <div class="winner-info1 winner-info1-preview" id="info1Preview" style="font-size: 0.9rem; font-weight: 500; color: #555; margin-bottom: 0.3rem; line-height: 1.1;">John Doe</div>
                          <div class="winner-info2 winner-info2-preview" id="info2Preview" style="font-size: 1.8rem; font-weight: 600; color: #222; margin-bottom: 0.3rem; line-height: 1.1;">Engineering</div>
                          <div class="winner-info3 winner-info3-preview" id="info3Preview" style="font-size: 0.8rem; font-weight: 400; color: #666; line-height: 1.1;">john.doe@company.com</div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <hr>
                <div class="d-flex gap-2 justify-content-end">
                  <button class="btn btn-success" id="confirmUpload">
                    <i class="bi bi-check-lg me-2"></i>Confirm Upload
                  </button>
                  <button class="btn btn-secondary" id="cancelUpload">
                    <i class="bi bi-x-lg me-2"></i>Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Data Preview Card - Full Width -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card" id="dataPreviewCard" style="display: none;">
              <div class="card-body">
                <h5 class="card-title">Data Preview</h5>
                <div class="table-responsive">
                  <table class="table table-sm" id="previewTable">
                    <thead id="previewHeaders"></thead>
                    <tbody id="previewBody"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Prizes Tab -->
      <div class="tab-pane fade" id="prizes" role="tabpanel" x-data>
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title mb-0">Prize Management</h5>
              <button class="btn btn-primary" id="addPrizeModalBtn">
                <i class="bi bi-plus-circle me-2"></i>Add
              </button>
            </div>
            <!-- Prizes Grid -->
            <div class="row g-4" id="prizesGrid">
              <template x-for="prize in $store.prizes.items" :key="prize.prizeId">
                <div class="col-md-6 col-lg-4">
                  <div class="card h-100 prize-card"
                       :class="{ 'border-primary': $store.setup.selectedPrizeId === prize.prizeId }">
                    <div class="card-header">
                      <div class="d-flex justify-content-between align-items-center">
                        <h6 class="card-title mb-0 text-truncate" x-text="prize.name" style="max-width: 180px;"></h6>
                        <span class="badge" :class="prize.quantity > 0 ? 'bg-success' : 'bg-secondary'" x-text="prize.quantity + ' available'"></span>
                      </div>
                    </div>
                    <div class="card-body d-flex flex-column">
                      <p class="card-text text-muted small mb-2" x-show="prize.description" x-text="prize.description"></p>
                      <div class="mt-auto pt-2">
                        <div class="d-flex justify-content-between align-items-center">
                          <button class="btn btn-sm"
                                  :class="$store.setup.selectedPrizeId === prize.prizeId ? 'btn-primary' : 'btn-outline-primary'"
                                  @click="$store.setup.selectedPrizeId = prize.prizeId">
                            <i :class="$store.setup.selectedPrizeId === prize.prizeId ? 'bi bi-check-circle-fill' : 'bi bi-check-circle'"></i>
                            <span x-text="$store.setup.selectedPrizeId === prize.prizeId ? 'Selected' : 'Select'"></span>
                          </button>
                          <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" @click="Prizes.editPrize(prize.prizeId)" title="Edit prize">
                              <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" @click="Prizes.deletePrizeConfirm(prize.prizeId)" title="Delete prize">
                              <i class="bi bi-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <!-- Empty state -->
            <div id="noPrizesMessage" class="text-center py-5" x-show="$store.prizes.items.length === 0">
              <i class="bi bi-gift display-1 text-muted"></i>
              <p class="text-muted mt-3">No prizes added yet</p>
              <button class="btn btn-primary" onclick="document.getElementById('addPrizeModalBtn').click()">
                <i class="bi bi-plus-circle me-2"></i>Add
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Templates Tab -->
      <div class="tab-pane fade" id="templates" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h5 class="card-title mb-0">SMS Templates</h5>
              <button class="btn btn-primary" id="addTemplateBtn">
                <i class="bi bi-plus-circle me-2"></i>Add Template
              </button>
            </div>
            
            <div class="alert alert-info" id="templatePlaceholders">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Available placeholders:</strong>
              <span id="placeholdersList">Loading...</span>
            </div>
            
            <div id="templatesGrid" class="row g-3">
              <!-- Templates will be loaded here -->
            </div>
          </div>
        </div>
      </div>
      <!-- Winners Tab -->
      <div class="tab-pane fade" id="winners" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">All Winners</h5>
              <div class="btn-group">
                <button class="btn btn-outline-primary" id="checkSMSStatusBtn" title="Check SMS delivery status for all pending messages">
                  <i class="bi bi-arrow-clockwise me-2"></i>Check SMS Status
                </button>
                <button class="btn btn-outline-success" id="exportWinnersBtn">
                  <i class="bi bi-download me-2"></i>Export CSV
                </button>
                <button class="btn btn-outline-danger" id="clearWinnersBtn">
                  <i class="bi bi-trash me-2"></i>Clear All
                </button>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-12">
                <label class="form-label">Filters</label>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md">
                <select id="filterPrize" class="form-select form-select-sm">
                  <option value="">All Prizes</option>
                </select>
              </div>
              <div class="col-md">
                <select id="filterList" class="form-select form-select-sm">
                  <option value="">All Lists</option>
                </select>
              </div>
              <div class="col-md">
                <select id="filterSelection" class="form-select form-select-sm">
                  <option value="">All Batches</option>
                </select>
              </div>
              <div class="col-md">
                <input type="date" id="filterDate" class="form-control form-control-sm" placeholder="Filter by date">
              </div>
              <div class="col-md-auto">
                <button class="btn btn-sm btn-outline-secondary" id="clearFiltersBtn">
                  <i class="bi bi-x-circle me-1"></i>Clear All
                </button>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="text-muted">
                <small id="winnersCount">Showing 0 winners</small>
              </div>
              <div class="text-muted">
                <small>
                  <span id="filterStatus"></span>
                </small>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>QR Code</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Prize</th>
                    <th>Date</th>
                    <th>List</th>
                    <th>Pickup</th>
                    <th>SMS</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="winnersTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- History Tab -->
      <div class="tab-pane fade" id="history" role="tabpanel">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Selection History & Statistics</h5>
            <div class="history-stats" id="historyStats">
              <div class="stat-card">
                <div class="stat-number" id="totalSelections">0</div>
                <div class="stat-label">Total Selections</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="totalWinners">0</div>
                <div class="stat-label">Total Winners</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="averageWinners">0</div>
                <div class="stat-label">Avg Winners/Selection</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="mostUsedPrize">-</div>
                <div class="stat-label">Most Used Prize</div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Filter by List</label>
              <select class="form-select" id="historyListFilter">
                <option value="">All Lists</option>
              </select>
            </div>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>List</th>
                    <th>Prize</th>
                    <th>Winners Count</th>
                    <th>Winners</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="historyTableBody">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <!-- Settings Tab -->
      <div class="tab-pane fade" id="settings" role="tabpanel" x-data>
        <div class="row">
          <div class="col-lg-6">
            <!-- Display Settings -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">General Settings</h5>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="preventDuplicates"
                           x-model="$store.settings.preventDuplicates"
                           @change="$store.settings.save('preventDuplicates')">
                    <label class="form-check-label" for="preventDuplicates">
                      Remove winners from source list
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Prevent the same person from winning multiple times"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="preventSamePrize"
                           x-model="$store.settings.preventSamePrize"
                           @change="$store.settings.save('preventSamePrize')">
                    <label class="form-check-label" for="preventSamePrize">
                      Prevent winning same prize twice
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Winners cannot win the same prize multiple times (e.g., can't win Jordans twice)"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="hideEntryCounts"
                           x-model="$store.settings.hideEntryCounts"
                           @change="$store.settings.save('hideEntryCounts')">
                    <label class="form-check-label" for="hideEntryCounts">
                      Hide Entry Counts
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Hide the number of participants in public view"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableDebugLogs"
                           x-model="$store.settings.enableDebugLogs"
                           @change="$store.settings.save('enableDebugLogs')">
                    <label class="form-check-label" for="enableDebugLogs">
                      Enable Debug Logs
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Show detailed console logs for debugging"></i>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <!-- Webhook Settings -->
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title">Webhook Settings</h5>
                <div class="mb-3">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="enableWebhook"
                           x-model="$store.settings.enableWebhook"
                           @change="$store.settings.save('enableWebhook')">
                    <label class="form-check-label" for="enableWebhook">
                      Enable Webhook Notifications
                      <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Send HTTP POST requests when winners are selected"></i>
                    </label>
                  </div>
                </div>
                <div class="mb-3" id="webhookUrlSection" x-show="$store.settings.enableWebhook" x-transition>
                  <label class="form-label" for="webhookUrl">
                    Webhook URL
                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="URL where winner selection notifications will be sent via POST request"></i>
                  </label>
                  <input type="url" class="form-control" id="webhookUrl" placeholder="https://example.com/webhook"
                         x-model="$store.settings.webhookUrl"
                         @change="$store.settings.save('webhookUrl')">
                  <div class="form-text">Winners data will be sent as JSON in the request body</div>
                </div>
              </div>
            </div>
            <!-- Sound Files Settings -->
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title">Sound Files</h5>
                <div class="mb-3">
                  <label class="form-label">Upload Sound Files</label>
                  <input type="file" class="form-control" id="soundFileInput" accept=".mp3" multiple style="display: none;">
                  <div class="form-text">Click the button below to select and upload MP3 files. All uploaded sounds will be available in all sound selection dropdowns.</div>
                </div>
                <button class="btn btn-primary" id="uploadSoundFilesBtn">
                  <i class="bi bi-upload me-2"></i>Upload Sound Files
                </button>
                <div class="mb-3 mt-3">
                  <label class="form-label">Available Sound Files</label>
                  <div id="soundFilesList" class="d-flex flex-column gap-2">
                    <!-- Sound files will be listed here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <!-- Theme Settings -->
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Theme & Appearance</h5>
                <div class="mb-3">
                  <label class="form-label">
                    Font Family
                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Choose the main font for the application"></i>
                  </label>
                  <select class="form-select" id="fontFamily"
                          x-model="$store.settings.fontFamily"
                          @change="$store.settings.save('fontFamily')">
                    <option value="Open Sans">Open Sans</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Inter">Inter</option>
                    <option value="Lato">Lato</option>
                    <option value="Poppins">Poppins</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Theme Colors</label>
                  <div class="row">
                    <div class="col-6">
                      <label class="form-label">Primary Color</label>
                      <input type="color" class="form-control color-input" id="primaryColor" value="#6366f1"
                             x-model="$store.settings.primaryColor"
                             @input="$store.settings.applyTheme()"
                             @change="$store.settings.save('primaryColor')">
                    </div>
                    <div class="col-6">
                      <label class="form-label">Secondary Color</label>
                      <input type="color" class="form-control color-input" id="secondaryColor" value="#8b5cf6"
                             x-model="$store.settings.secondaryColor"
                             @input="$store.settings.applyTheme()"
                             @change="$store.settings.save('secondaryColor')">
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">
                    Background Type
                    <i class="bi bi-info-circle text-muted ms-1" data-bs-toggle="tooltip" title="Choose background style for winner display"></i>
                  </label>
                  <select class="form-select" id="backgroundType"
                          x-model="$store.settings.backgroundType"
                          @change="$store.settings.save('backgroundType')">
                    <option value="gradient">Gradient</option>
                    <option value="solid">Solid Color</option>
                    <option value="image">Custom Image</option>
                  </select>
                </div>
                <div class="mb-3" id="backgroundImageUpload" x-show="$store.settings.backgroundType === 'image'" x-transition>
                  <label class="form-label">Background Image</label>
                  
                  <!-- Toggle buttons for selecting or uploading -->
                  <div class="btn-group w-100 mb-3" role="group">
                    <button type="button" class="btn btn-outline-primary active" id="selectExistingBtn" onclick="Settings.showImageSection('existing')">
                      Select Existing
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="uploadNewBtn" onclick="Settings.showImageSection('upload')">
                      Upload New
                    </button>
                  </div>
                  
                  <!-- Existing images gallery -->
                  <div id="selectExistingSection">
                    <div id="existingImagesGallery" class="row g-2">
                      <!-- Images will be populated here -->
                    </div>
                    <p class="text-muted small mt-2">Click an image to select it as background</p>
                  </div>
                  
                  <!-- Upload new image -->
                  <div id="uploadNewSection" style="display: none;">
                    <input type="file" class="form-control" id="backgroundImage" accept="image/*">
                    <small class="text-muted">Upload a new image to use as background</small>
                  </div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Theme Presets</label>
                  <div class="row g-2">
                    <div class="col-4">
                      <button class="btn btn-outline-primary w-100 theme-preset" data-theme="default">
                        <i class="bi bi-palette me-1"></i>Default
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-success w-100 theme-preset" data-theme="emerald">
                        <i class="bi bi-gem me-1"></i>Emerald
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-danger w-100 theme-preset" data-theme="ruby">
                        <i class="bi bi-diamond me-1"></i>Ruby
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-warning w-100 theme-preset" data-theme="gold">
                        <i class="bi bi-star me-1"></i>Gold
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-info w-100 theme-preset" data-theme="ocean">
                        <i class="bi bi-water me-1"></i>Ocean
                      </button>
                    </div>
                    <div class="col-4">
                      <button class="btn btn-outline-secondary w-100 theme-preset" data-theme="corporate">
                        <i class="bi bi-building me-1"></i>Corporate
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  </div>
  <!-- Progress Overlay -->
  <div id="progressOverlay" class="progress-overlay d-none">
    <div class="progress-content">
      <h5 id="progressTitle">Processing...</h5>
      <div class="progress-bar-custom">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p id="progressText">Please wait...</p>
    </div>
  </div>
  
  <!-- Countdown Animation Overlay -->
  <div class="countdown-animation d-none" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
    <canvas id="countdownCanvas"></canvas>
  </div>
  <!-- Animation Canvas - outside countdown so it's always available -->
  <canvas id="animationCanvas"></canvas>
  <!-- Pre-Display Delay Overlay -->
  <div class="delay-overlay d-none" id="delayOverlay">
    <div class="delay-content">
      <div id="delaySpinner" class="delay-spinner d-none">
        <div class="spinner-border text-light" role="status" style="width: 3rem; height: 3rem;">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div class="mt-3 text-light">Preparing winners...</div>
      </div>
      <div id="delayCountdown" class="delay-countdown d-none">
        <div class="countdown-circle">
          <span id="delayCountdownNumber">5</span>
        </div>
        <div class="mt-3 text-light">Winners in...</div>
      </div>
      <div id="delayProgress" class="delay-progress d-none">
        <div class="progress-container">
          <div class="progress-bar-delay" id="delayProgressBar"></div>
        </div>
        <div class="mt-3 text-light">Finalizing selection...</div>
      </div>
      <div id="delayDots" class="delay-dots d-none">
        <div class="dots-container">
          <span class="dot"></span>
          <span class="dot"></span>
          <span class="dot"></span>
        </div>
        <div class="mt-3 text-light">Getting ready...</div>
      </div>
    </div>
  </div>
  <!-- Hidden file input for restore -->
  <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
  <!-- Generic Modal -->
  <div class="modal fade" id="appModal" tabindex="-1" aria-labelledby="appModalLabel" x-data="confirmModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="appModalLabel" x-text="title">Modal title</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="appModalBody">
          <p x-text="message"></p>
          <div x-html="customContent" x-show="customContent"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn" :class="confirmClass" id="appModalConfirmBtn" @click="confirm()" x-text="confirmText">Confirm</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Import Modal -->
  <div class="modal fade" id="reportImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import from Giveaway Report</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reportImportForm">
            <div class="mb-3">
              <label for="reportType" class="form-label">Report Type</label>
              <select class="form-select" id="reportType" required>
                <option value="">Select a report...</option>
                <option value="export_giveaways_adults_car.sql">Adults - Car Giveaway (License Required)</option>
                <option value="export_giveaways_adults_general.sql">Adults - General Giveaway</option>
                <option value="export_giveaways_minors_over_12.sql">Teens - Over 12</option>
                <option value="export_giveaways_minors_under_12.sql">Kids - Under 12</option>
                <option value="export_giveaways_minors_all.sql">Minors - All Ages</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="eventId" class="form-label">Event ID</label>
              <input type="number" class="form-control" id="eventId" value="19" required>
            </div>
            
            <div class="mb-3">
              <label for="timeRange" class="form-label">Time Range</label>
              <select class="form-select" id="timeRange" required>
                <option value="today">Today (4am to now)</option>
                <option value="morning">Morning (4am - 3pm CDT)</option>
                <option value="night">Night (3pm - 4am CDT)</option>
                <option value="last5">Last 5 Hours</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            
            <div id="customTimeRange" class="d-none">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="customStart" class="form-label">Start Time</label>
                  <input type="datetime-local" class="form-control" id="customStart">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="customEnd" class="form-label">End Time</label>
                  <input type="datetime-local" class="form-control" id="customEnd">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="listName" class="form-label">List Name</label>
              <input type="text" class="form-control" id="reportListName" placeholder="e.g., Morning Car Giveaway" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="importReportBtn">
            <i class="bi bi-download me-2"></i>Import Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MinistryPlatform Import Modal -->
  <div class="modal fade" id="mpImportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Import from Ministry Platform</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="mpImportForm">
            <!-- Query Selection -->
            <div class="mb-3">
              <label for="mpQuerySelect" class="form-label">Select Query</label>
              <select class="form-select" id="mpQuerySelect" required>
                <option value="">Loading queries...</option>
              </select>
              <div class="form-text" id="mpQueryDescription"></div>
            </div>
            
            <!-- Dynamic Parameters -->
            <div id="mpParametersSection" style="display: none;">
              <h6 class="mb-3">Query Parameters</h6>
              <div id="mpParametersContainer"></div>
            </div>
            
            <!-- Preview Section -->
            <div id="mpPreviewSection" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Preview</h6>
                <span class="badge bg-primary" id="mpRecordCount">0 records</span>
              </div>
              <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                <table class="table table-sm table-striped" id="mpPreviewTable">
                  <thead></thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
            
            <!-- List Name -->
            <div class="mb-3 mt-3">
              <label for="mpListName" class="form-label">List Name</label>
              <input type="text" class="form-control" id="mpListName" placeholder="e.g., Youth Group Members" required>
            </div>
            
            <!-- Error Display -->
            <div class="alert alert-danger" id="mpErrorAlert" style="display: none;"></div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="mpImportBtn" style="display: none;">
            <i class="bi bi-download me-2"></i>Import Data
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script>
    // Suppress Bootstrap's known JSON parsing bug for tabs and dropdowns
    // This is a known issue in Bootstrap 5.3.x that doesn't affect functionality
    const originalParse = JSON.parse;
    JSON.parse = function(text) {
      // Bootstrap tries to parse "tab", "dropdown" and "#selector" as JSON, which fails
      // but doesn't break functionality - just suppress these specific errors
      if (text === 'tab' || text === 'tooltip' || text === 'dropdown' || (typeof text === 'string' && text.startsWith('#'))) {
        return {};
      }
      return originalParse.apply(this, arguments);
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Toastify JS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- Alpine.js Persist Plugin (loads and executes first, registers $persist) -->
  <script src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.14.9/dist/cdn.min.js"></script>

  <!-- Alpine.js Store Registration - must be AFTER persist plugin -->
  <script>
    document.addEventListener('alpine:init', () => {
      // Settings store with persistence
      Alpine.store('settings', {
        // General settings
        preventDuplicates: Alpine.$persist(false).as('settings_preventDuplicates'),
        preventSamePrize: Alpine.$persist(false).as('settings_preventSamePrize'),
        hideEntryCounts: Alpine.$persist(false).as('settings_hideEntryCounts'),
        enableDebugLogs: Alpine.$persist(false).as('settings_enableDebugLogs'),
        enableWebhook: Alpine.$persist(false).as('settings_enableWebhook'),
        webhookUrl: Alpine.$persist('').as('settings_webhookUrl'),

        // Theme settings
        fontFamily: Alpine.$persist('Open Sans').as('settings_fontFamily'),
        primaryColor: Alpine.$persist('#6366f1').as('settings_primaryColor'),
        secondaryColor: Alpine.$persist('#8b5cf6').as('settings_secondaryColor'),
        backgroundType: Alpine.$persist('gradient').as('settings_backgroundType'),
        customBackgroundImage: Alpine.$persist(null).as('settings_customBackgroundImage'),

        // Selection display settings
        selectionMode: Alpine.$persist('all-at-once').as('settings_selectionMode'),
        displayEffect: Alpine.$persist('fade-in').as('settings_displayEffect'),
        displayDuration: Alpine.$persist(0.5).as('settings_displayDuration'),
        preSelectionDelay: Alpine.$persist(0).as('settings_preSelectionDelay'),
        delayVisualType: Alpine.$persist('none').as('settings_delayVisualType'),

        // Sound settings
        soundDuringDelay: Alpine.$persist('none').as('settings_soundDuringDelay'),
        soundEndOfDelay: Alpine.$persist('none').as('settings_soundEndOfDelay'),
        soundDuringReveal: Alpine.$persist('none').as('settings_soundDuringReveal'),

        // Celebration settings
        celebrationEffect: Alpine.$persist('confetti').as('settings_celebrationEffect'),
        celebrationDuration: Alpine.$persist(4).as('settings_celebrationDuration'),
        celebrationAutoTrigger: Alpine.$persist(true).as('settings_celebrationAutoTrigger'),

        // SMS Template
        smsTemplate: Alpine.$persist('Congratulations {name}! You won {prize}. Your code: {contactId}').as('settings_smsTemplate'),

        init() {
          // Sync with backend on load (non-blocking)
          this.loadFromServer();
        },

        async loadFromServer() {
          // Bridge to existing database.js - will be implemented after module loads
        },

        async save(key) {
          // Bridge to existing Settings.saveSingleSetting() - will be connected after module loads
          if (window.Settings && window.Settings.saveSingleSetting) {
            await window.Settings.saveSingleSetting(key, this[key]);
          }
        },

        applyTheme() {
          // Apply CSS variables for live preview
          document.documentElement.style.setProperty('--bs-primary', this.primaryColor);
          document.documentElement.style.setProperty('--color-primary', this.primaryColor);
          document.documentElement.style.setProperty('--color-secondary', this.secondaryColor);
        }
      });

      // Quick setup state
      Alpine.store('setup', {
        selectedListIds: Alpine.$persist([]).as('setup_selectedListIds'),
        selectedPrizeId: Alpine.$persist('').as('setup_selectedPrizeId'),
        winnersCount: Alpine.$persist(1).as('setup_winnersCount'),

        get canStart() {
          return this.selectedListIds.length > 0 && this.selectedPrizeId;
        },

        get totalEntries() {
          const listsStore = Alpine.store('lists');
          if (!listsStore || !listsStore.items) return 0;
          return this.selectedListIds.reduce((total, listId) => {
            const list = listsStore.items.find(l => l.listId === listId);
            return total + (list ? list.entries.length : 0);
          }, 0);
        },

        get listDisplayText() {
          const listsStore = Alpine.store('lists');
          if (!listsStore || !listsStore.items) return 'Not Selected';
          if (this.selectedListIds.length === 0) return 'Not Selected';
          if (this.selectedListIds.length === 1) {
            const list = listsStore.items.find(l => l.listId === this.selectedListIds[0]);
            return list?.metadata?.name || 'Unknown';
          }
          return `${this.selectedListIds.length} Lists Selected`;
        },

        get prizeDisplayText() {
          const prizesStore = Alpine.store('prizes');
          if (!prizesStore || !prizesStore.items) return 'Not Selected';
          if (!this.selectedPrizeId) return 'Not Selected';
          const prize = prizesStore.items.find(p => p.prizeId === this.selectedPrizeId);
          return prize?.name || 'Not Selected';
        },

        isListSelected(listId) {
          return this.selectedListIds.includes(listId);
        },

        toggleList(listId) {
          const idx = this.selectedListIds.indexOf(listId);
          if (idx > -1) {
            this.selectedListIds.splice(idx, 1);
          } else {
            this.selectedListIds.push(listId);
          }
        },

        selectList(listId) {
          if (!this.selectedListIds.includes(listId)) {
            this.selectedListIds.push(listId);
          }
        },

        deselectList(listId) {
          const idx = this.selectedListIds.indexOf(listId);
          if (idx > -1) {
            this.selectedListIds.splice(idx, 1);
          }
        }
      });

      // Data stores
      Alpine.store('lists', {
        items: [],
        loading: false,

        async load() {
          // Will be connected to Database.getFromStore('lists')
        },

        setItems(items) {
          this.items = items || [];
        }
      });

      Alpine.store('prizes', {
        items: [],
        loading: false,

        async load() {
          // Will be connected to Database.getFromStore('prizes')
        },

        setItems(items) {
          this.items = items || [];
        },

        get available() {
          // Prizes with quantity > 0
          return this.items.filter(p => p.quantity > 0);
        }
      });

      Alpine.store('winners', {
        items: [],
        filters: {
          prize: '',
          list: '',
          batch: '',
          date: ''
        },

        get filtered() {
          return this.items.filter(w => {
            if (this.filters.prize && w.prizeId !== this.filters.prize) return false;
            if (this.filters.list && w.listId !== this.filters.list) return false;
            return true;
          });
        },

        setItems(items) {
          this.items = items || [];
        },

        clearFilters() {
          this.filters = { prize: '', list: '', batch: '', date: '' };
        }
      });

      // UI state store
      Alpine.store('ui', {
        view: Alpine.$persist('public').as('ui_view'), // 'public' or 'management'
        currentTab: Alpine.$persist('quicksetup').as('ui_currentTab'),
        showWinnersGrid: false,
        isSelecting: false,

        init() {
          // Restore view on page load after DOM is ready
          const restoreView = () => {
            try {
              const publicEl = document.getElementById('publicInterface');
              const managementEl = document.getElementById('managementInterface');

              if (this.view === 'management') {
                if (publicEl) publicEl.classList.add('d-none');
                if (managementEl) managementEl.classList.add('active');
                // Activate the saved tab
                const tabTrigger = document.querySelector(`[data-bs-target="#${this.currentTab}"]`);
                if (tabTrigger && window.bootstrap) {
                  const tab = new bootstrap.Tab(tabTrigger);
                  tab.show();
                }
              } else {
                // Ensure public view is shown
                if (publicEl) publicEl.classList.remove('d-none');
                if (managementEl) managementEl.classList.remove('active');
              }
            } catch (e) {
              console.warn('Error restoring UI state:', e);
            }
          };

          // Wait for DOM to be ready
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', restoreView);
          } else {
            setTimeout(restoreView, 150);
          }
        },

        showManagement() {
          this.view = 'management';
          document.getElementById('publicInterface')?.classList.add('d-none');
          document.getElementById('managementInterface')?.classList.add('active');
        },

        showPublic() {
          this.view = 'public';
          document.getElementById('publicInterface')?.classList.remove('d-none');
          document.getElementById('managementInterface')?.classList.remove('active');
        },

        setTab(tabId) {
          this.currentTab = tabId;
        }
      });

      // Reusable component: Confirmation Modal
      Alpine.data('confirmModal', () => ({
        title: '',
        message: '',
        customContent: '',
        confirmText: 'Confirm',
        confirmClass: 'btn-danger',
        onConfirm: null,
        bsModal: null,

        init() {
          // Use getOrCreateInstance to avoid duplicate modal instances
          this.bsModal = bootstrap.Modal.getOrCreateInstance(this.$el);
          // Make this component globally accessible for UI.showConfirmationModal bridge
          window.alpineConfirmModal = this;
          // Also set window.appModal for legacy code that uses it directly
          window.appModal = this.bsModal;
        },

        show(options) {
          this.title = options.title || '';
          this.message = options.message || '';
          this.customContent = options.customContent || '';
          this.confirmText = options.confirmText || 'Confirm';
          this.confirmClass = options.confirmClass || 'btn-danger';
          this.onConfirm = options.onConfirm || null;
          this.bsModal.show();
        },

        confirm() {
          if (this.onConfirm) this.onConfirm();
          this.bsModal.hide();
          this.reset();
        },

        close() {
          this.bsModal.hide();
          this.reset();
        },

        reset() {
          this.title = '';
          this.message = '';
          this.customContent = '';
          this.confirmText = 'Confirm';
          this.confirmClass = 'btn-danger';
          this.onConfirm = null;
        }
      }));
    });
  </script>

  <!-- Alpine.js Core (loads after inline setup, triggers alpine:init) -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js"></script>

  <!-- Vite Entry Point -->
  <script type="module" src="./src/main.js"></script>
</body>
</html>